---
title: "Pre-process the data for PENCIL input"
author: "Tiangen Chang tiangen.chang@nih.gov"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r}
# clear all objects including hidden objects
rm(list = ls(all.names = TRUE)) 
# free up memory and report the memory usage
gc()
```


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment = FALSE, 
                      warning = FALSE, 
                      message = FALSE)
require(ggplot2)
ggplot2::theme_set(new = theme_bw(base_size = 12)) # sets the theme and axis font size
```

# Connect to server
```{bash}
ssh changt7@biowulf.nih.gov
sinteractive --mem=64g --cpus-per-task=32 --time=24:00:00
sinteractive --mem=128g --cpus-per-task=32 --gres=gpu:k80:2 --time=24:00:00
# --gres=lscratch:1024
module load R/
R

```

# load required package
```{r, include=FALSE}
#if (!require("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
#BiocManager::install("UCell")
library(UCell)

#devtools::install_github("mojaveazure/seurat-disk")
#devtools::install_github('satijalab/seurat-data')
library(SeuratData)
library(SeuratDisk)

library(caret)
library(Seurat)
library(GEOquery)
library(dplyr)
library(ggplot2)
library(SingleR)
library(sctransform)
library(celldex)
library(dittoSeq)
library(SeuratWrappers)
library(harmony)
library(scuttle)
library(scran)
library(scFeatureFilter)
library(cowplot)
library(patchwork)
library(edgeR)
library(RColorBrewer)
library(stringr)

```

# set input and output directories & parameters
```{r}

dataset = 'GSE120575' # 'GSE200996'   'GSE120575'   'GSE169246'

# local
data_dir <- paste0("/Users/changt7/Documents/00.PostDocWork/CancerResearch/01.Projects/00.Collaborating_projects/05.PENCIL/02.Input/", dataset, '/')
processed_dir <- paste0("../03.Results/", dataset, '/')
fig_dir <- paste0("../03.Results/", dataset, '/Figures/')

# server
shared_data_dir = paste0("/data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/02.Input/")
data_dir <- paste0(shared_data_dir, dataset, '/')
processed_dir <- paste0("/data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/", dataset, '/')
fig_dir = paste0("/data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/", dataset, "/Figures/")
PENCIL_result_dir = paste0("/data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/01.Scripts/results/")
```

# load raw seurat object
```{r}

sampleType_name = 'Tissue' # 'merged_seu'  'Tissue'

merged_seu = readRDS(file = paste0(processed_dir,"seu_",sampleType_name,"_all_raw.rds"))

```


# filter, normalize, scale, and make .h5ad file for celltypist cell annotation
```{r}

# filter genes to keep only protein coding genes
protein_coding_gene_file = paste0(shared_data_dir, 'Feldman_protein_coding_genes.csv')
protein_coding_genes=read.csv(protein_coding_gene_file, header=T)[,1]
genes <- intersect(protein_coding_genes, row.names(merged_seu))
merged_seu <- merged_seu[genes, ]

# Normalization, scaling, dimension reduction, and clustering
merged_seu <- NormalizeData(object=merged_seu, normalization.method="LogNormalize")
merged_seu <- FindVariableFeatures(object=merged_seu, selection.method='vst', nfeatures=2000)
merged_seu <- ScaleData(object=merged_seu)
merged_seu <- RunPCA(object=merged_seu, features=VariableFeatures(merged_seu))
merged_seu <- FindNeighbors(object=merged_seu, dims=1:10, k.param=20)
merged_seu <- FindClusters(object=merged_seu, resolution=1.6)
merged_seu <- RunUMAP(object=merged_seu, dims=1:10)

# save for .h5ad as celltypist's input
SaveH5Seurat(merged_seu, filename = paste0(processed_dir,"seu_",sampleType_name,"_all.h5Seurat"), overwrite = TRUE)
Convert(paste0(processed_dir,"seu_",sampleType_name,"_all.h5Seurat"), dest = "h5ad", assay = "RNA", overwrite = TRUE) # .X: only scaled data for HVGs. .raw.X: all genes 
saveRDS(object = merged_seu, file = paste0(processed_dir,"seu_",sampleType_name,"_all.rds")) 

```


# celltypist annotation
```{bash}

celltypist --indata /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/seu_Tissue_all.h5ad --model Immune_All_Low.pkl --outdir /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/ --prefix Tissue_all_celltypist_ImmuneAllLow_ --majority-voting

```

# add cell type annotation to seurat object
```{r}

merged_seu = readRDS(file = paste0(processed_dir,"seu_",sampleType_name,"_all.rds"))

cell_types_to_keep = c("CD8T-cells")
confidence_cutoff = 0.1 #  set cell labels to "Other" if confidence below confidence_cutoff (about 6% cells having conf < 0.1)

prediction_labels <- read.csv(paste0(processed_dir, sampleType_name,"_all_celltypist_ImmuneAllLow_predicted_labels.csv"), row.names = 1)
prediction_prob <- read.csv(paste0(processed_dir, sampleType_name,"_all_celltypist_ImmuneAllLow_probability_matrix.csv"), row.names = 1)
prediction_prob_max = data.frame(max_value = apply(prediction_prob, 1, max, na.rm = TRUE))
colnames(prediction_prob_max) = c('probability')
prediction_labels_prob <- cbind(prediction_labels[c('predicted_labels')], prediction_prob_max[c('probability')])

merged_seu$cell_type_celltypist_raw <- prediction_labels_prob$predicted_labels
merged_seu$cell_type_celltypist_raw_prob <- prediction_labels_prob$probability

merged_seu$cell_type_celltypist = merged_seu$cell_type_celltypist_raw
merged_seu$cell_type_celltypist <- ifelse(grepl("CD8|cytotoxic T|MAIT", merged_seu$cell_type_celltypist, ignore.case = FALSE), "CD8T-cells", merged_seu$cell_type_celltypist)
if (length(unique(merged_seu$cell_type_celltypist)) > length(cell_types_to_keep)){
  merged_seu$cell_type_celltypist <- recode(merged_seu$cell_type_celltypist, !!!setNames(rep("Other", length(setdiff(unique(merged_seu$cell_type_celltypist), cell_types_to_keep))), setdiff(unique(merged_seu$cell_type_celltypist), cell_types_to_keep)))
}
merged_seu$cell_type_celltypist[merged_seu$cell_type_celltypist_raw_prob < confidence_cutoff] = "Other"

```


# cell annotation using singler
```{r}

confidence_cutoff = 0.4 # set cell labels to "Other" if confidence below confidence_cutoff (about 6% cells having conf < 0.4)

# cell annotation using BlueprintEncodeData. This reference only contains "naive B-cells", "Memory B-cells" and "Plasma cells". No other B cell types.
cellType_anno_fn = paste0(processed_dir, sampleType_name,"_singleR_BlueprintEncodeData_predicted_labels.csv")
if(file.exists(cellType_anno_fn)){
  singler.anno1 <- read.csv(cellType_anno_fn, row.names = 1)
} else {
  ref1 <- celldex::BlueprintEncodeData()
  singleR <- as.SingleCellExperiment(merged_seu, assay= "RNA") 
  singler.anno1 <- SingleR(test = singleR, ref = ref1, labels = (ref1$label.main)) # label.main
  write.csv(singler.anno1, file = cellType_anno_fn, row.names = TRUE)
}
cell_labelsProb_df <- data.frame(max_value = apply(singler.anno1$scores, 1, max, na.rm = TRUE))
cell_labels_df = cbind(singler.anno1$labels, cell_labelsProb_df)
colnames(cell_labels_df) = c('predicted_labels', 'probability')

merged_seu$cell_type_ENCODE_raw <- cell_labels_df$predicted_labels
merged_seu$cell_type_ENCODE_raw_prob <- cell_labels_df$probability

merged_seu$cell_type_ENCODE <- merged_seu$cell_type_ENCODE_raw
merged_seu$cell_type_ENCODE <- ifelse(grepl("CD8+", merged_seu$cell_type_ENCODE, ignore.case = TRUE), "CD8T-cells", merged_seu$cell_type_ENCODE)
if (length(unique(merged_seu$cell_type_ENCODE)) > length(cell_types_to_keep)){
  merged_seu$cell_type_ENCODE <- recode(merged_seu$cell_type_ENCODE, !!!setNames(rep("Other", length(setdiff(unique(merged_seu$cell_type_ENCODE), cell_types_to_keep))), setdiff(unique(merged_seu$cell_type_ENCODE), cell_types_to_keep)))
}
merged_seu$cell_type_ENCODE[merged_seu$cell_type_ENCODE_raw_prob < confidence_cutoff] = "Other"


```


# make PENCIL input 1: use originally annotated CD8T cells
```{r}

#merged_seu = readRDS(file = paste0(processed_dir,"seu_",sampleType_name,"_all.rds"))

phenotype_name = 'ResponseInfo' 
cellType_of_interest = 'CD8T' 

merged_seu_subset <- subset(merged_seu, subset = cell_type_originalCD8T %in% c("CD8+ T-cells"))
print(merged_seu_subset)

merged_seu_subset <- FindVariableFeatures(object=merged_seu_subset, selection.method='vst', nfeatures=2000)
merged_seu_subset <- ScaleData(merged_seu_subset)
merged_seu_subset <- RunPCA(merged_seu_subset, pc.genes = merged_seu_subset@var.genes)
merged_seu_subset <- RunUMAP(merged_seu_subset, reduction = "pca", dims = 1:10)
merged_seu_subset <- FindNeighbors(merged_seu_subset, reduction = "pca", dims=1:10, k.param=20)
merged_seu_subset <- FindClusters(merged_seu_subset, resolution = 0.8)

################ 1: use the default gene order (expression variability from high to low) ################
variable_genes <- VariableFeatures(merged_seu_subset)
exp_data_scaled = merged_seu_subset@assays[["RNA"]]@scale.data[variable_genes,]
write.csv(exp_data_scaled, file=paste0(processed_dir,"seu_",sampleType_name,'_',cellType_of_interest,".csv"))
cell_label_df = data.frame(label = merged_seu_subset$ResponseInfo)
write.csv(cell_label_df, file=paste0(processed_dir,"cell_label_info.csv"))
emd = merged_seu_subset@reductions[["umap"]]@cell.embeddings
write.csv(emd, file=paste0(processed_dir, "seu_",sampleType_name,'_',cellType_of_interest,'_embedding_umap.csv'))

################ 2: use altered gene order (expression variability from low to high) ################
reversed_genes <- rev(variable_genes)
exp_data_scaled = merged_seu_subset@assays[["RNA"]]@scale.data[variable_genes,]
write.csv(exp_data_scaled, file=paste0(processed_dir,"seu_",sampleType_name,'_',cellType_of_interest,"_variability_low2high.csv"))

################ 3: use altered gene order (mean expression from low to high) ################
variable_expression <- merged_seu_subset@assays[['RNA']]@data[variable_genes, ]
mean_expression <- rowMeans(variable_expression)
mean_expression_df <- data.frame(gene = rownames(variable_expression), mean_expression)
ranked_genes <- mean_expression_df[order(mean_expression_df$mean_expression, decreasing = F), ]
ranked_genes_low2high = ranked_genes$gene
exp_data_scaled = merged_seu_subset@assays[["RNA"]]@scale.data[ranked_genes_low2high,]
write.csv(exp_data_scaled, file=paste0(processed_dir,"seu_",sampleType_name,'_',cellType_of_interest,"_geneExp_low2high.csv"))

################ 4: use altered gene order (gene name from A to Z) ################
variable_genes_OrderByName = sort(variable_genes)
exp_data_scaled = merged_seu_subset@assays[["RNA"]]@scale.data[variable_genes_OrderByName,]
write.csv(exp_data_scaled, file=paste0(processed_dir,"seu_",sampleType_name,'_',cellType_of_interest,"_geneName_a2z.csv"))


saveRDS(object = merged_seu_subset, file = paste0(processed_dir, "seu_",sampleType_name,"_", cellType_of_interest, "_Feldman.rds")) 

```



# make PENCIL input 2: use 70% originally annotated CD8T cells
```{r}

merged_seu_subset_train = subset(merged_seu_subset, subset = meta_train %in% c(1))

merged_seu_subset_train <- FindVariableFeatures(object=merged_seu_subset_train, selection.method='vst', nfeatures=2000)
merged_seu_subset_train <- ScaleData(merged_seu_subset_train)

# save train data
exp_data_scaled = merged_seu_subset_train@assays[["RNA"]]@scale.data[VariableFeatures(merged_seu_subset_train),]
write.csv(exp_data_scaled, file=paste0(processed_dir,"seu_",sampleType_name,'_',cellType_of_interest,"_Train.csv"))
cell_label_df = data.frame(label = merged_seu_subset_train$ResponseInfo)
write.csv(cell_label_df, file=paste0(processed_dir,"cell_label_info_Train.csv"))
emd = merged_seu_subset_train@reductions[["umap"]]@cell.embeddings
write.csv(emd, file=paste0(processed_dir, "seu_",sampleType_name,'_',cellType_of_interest,'_Train_embedding_umap.csv'))


saveRDS(object = merged_seu_subset_train, file = paste0(processed_dir, "seu_",sampleType_name,"_", cellType_of_interest, "_Feldman_0.7sample.rds")) 

```

# make PENCIL input 3: use celltypist annotated CD8T cells
```{r}

#merged_seu = readRDS(file = paste0(processed_dir,"seu_",sampleType_name,"_all.rds"))

merged_seu_subset <- subset(merged_seu, subset = cell_type_celltypist %in% c("CD8T-cells"))
print(merged_seu_subset)

merged_seu_subset <- FindVariableFeatures(object=merged_seu_subset, selection.method='vst', nfeatures=2000)
merged_seu_subset <- ScaleData(merged_seu_subset)

variable_genes <- VariableFeatures(merged_seu_subset)
exp_data_scaled = merged_seu_subset@assays[["RNA"]]@scale.data[variable_genes,]
write.csv(exp_data_scaled, file=paste0(processed_dir,"seu_",sampleType_name,'_',cellType_of_interest,"_celltypist.csv"))
cell_label_df = data.frame(label = merged_seu_subset$ResponseInfo)
write.csv(cell_label_df, file=paste0(processed_dir,"cell_label_info_celltypist.csv"))
emd = merged_seu_subset@reductions[["umap"]]@cell.embeddings
write.csv(emd, file=paste0(processed_dir, "seu_",sampleType_name,'_',cellType_of_interest,'_embedding_umap_celltypist.csv'))

saveRDS(object = merged_seu_subset, file = paste0(processed_dir, "seu_",sampleType_name,"_", cellType_of_interest, "_celltypist.rds")) 

```


# make PENCIL input 4: use singler annotated CD8T cells
```{r}

#merged_seu = readRDS(file = paste0(processed_dir,"seu_",sampleType_name,"_all.rds"))

merged_seu_subset <- subset(merged_seu, subset = cell_type_ENCODE %in% c("CD8T-cells"))
print(merged_seu_subset)

merged_seu_subset <- FindVariableFeatures(object=merged_seu_subset, selection.method='vst', nfeatures=2000)
merged_seu_subset <- ScaleData(merged_seu_subset)

variable_genes <- VariableFeatures(merged_seu_subset)
exp_data_scaled = merged_seu_subset@assays[["RNA"]]@scale.data[variable_genes,]
write.csv(exp_data_scaled, file=paste0(processed_dir,"seu_",sampleType_name,'_',cellType_of_interest,"_singler.csv"))
cell_label_df = data.frame(label = merged_seu_subset$ResponseInfo)
write.csv(cell_label_df, file=paste0(processed_dir,"cell_label_info_singler.csv"))
emd = merged_seu_subset@reductions[["umap"]]@cell.embeddings
write.csv(emd, file=paste0(processed_dir, "seu_",sampleType_name,'_',cellType_of_interest,'_embedding_umap_singler.csv'))

saveRDS(object = merged_seu_subset, file = paste0(processed_dir, "seu_",sampleType_name,"_", cellType_of_interest, "_singler.rds")) 

```


# Run PENCIL
```{bash}

## use gpu to accelerate PENCIL
sinteractive --mem=128g --cpus-per-task=32 --gres=gpu:k80:2 --time=24:00:00
module load python/3.8

## Run PENCIL for original CD8T annotation (use the default gene order) with class weights = 1:1
python Run_PENCIL_csv.py /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/seu_Tissue_CD8T.csv /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/cell_label_info.csv /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/seu_Tissue_CD8T_embedding_umap.csv GSE120575_Tissue_CD8T ICBresponse1 multi-classification 1,1

## Run PENCIL for original CD8T annotation (use the default gene order) with class weights = 1:2
python Run_PENCIL_csv.py /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/seu_Tissue_CD8T.csv /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/cell_label_info.csv /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/seu_Tissue_CD8T_embedding_umap.csv GSE120575_Tissue_CD8T ICBresponse2 multi-classification 1,2

## Run PENCIL for original CD8T annotation (use the low to high variability gene order)
python Run_PENCIL_csv.py /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/seu_Tissue_CD8T_variability_low2high.csv /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/cell_label_info.csv /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/seu_Tissue_CD8T_embedding_umap.csv GSE120575_Tissue_CD8T ICBresponse3 multi-classification 1,2

## Run PENCIL for original CD8T annotation (use the low to high mean expression gene order)
python Run_PENCIL_csv.py /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/seu_Tissue_CD8T_geneExp_low2high.csv /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/cell_label_info.csv /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/seu_Tissue_CD8T_embedding_umap.csv GSE120575_Tissue_CD8T ICBresponse4 multi-classification 1,2

## Run PENCIL for original CD8T annotation (use the A to Z gene name gene order)
python Run_PENCIL_csv.py /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/seu_Tissue_CD8T_geneName_a2z.csv /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/cell_label_info.csv /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/seu_Tissue_CD8T_embedding_umap.csv GSE120575_Tissue_CD8T ICBresponse5 multi-classification 1,2

## Run PENCIL for original CD8T annotation (use 70% samples)
python Run_PENCIL_csv.py /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/seu_Tissue_CD8T_Train.csv /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/cell_label_info_Train.csv /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/seu_Tissue_CD8T_embedding_umap_Train.csv GSE120575_Tissue_CD8T ICBresponse6 multi-classification 1,2

## Run PENCIL for celltypist annotated CD8T cells (use the default gene order)
python Run_PENCIL_csv.py /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/seu_Tissue_CD8T_celltypist.csv /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/cell_label_info_celltypist.csv /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/seu_Tissue_CD8T_embedding_umap_celltypist.csv GSE120575_Tissue_CD8T ICBresponse7 multi-classification 1,2

## Run PENCIL for singler annotated CD8T cells (use the default gene order)
python Run_PENCIL_csv.py /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/seu_Tissue_CD8T_singler.csv /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/cell_label_info_singler.csv /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/seu_Tissue_CD8T_embedding_umap_singler.csv GSE120575_Tissue_CD8T ICBresponse8 multi-classification 1,2


```


# Add PENCIL identified phenotypic cell labels to seurat object (original CD8T cells)
```{r}

# load seurat object
merged_seu_subset = readRDS(file = paste0(processed_dir,"seu_",sampleType_name,'_',cellType_of_interest,"_Feldman.rds"))


######### PENCIL result with class weights = 1:1
phenotype_name = 'ICBresponse1'
predicted_cell_labels = read.csv(paste0(PENCIL_result_dir, dataset, '_', sampleType_name, '_', cellType_of_interest,"/py/", phenotype_name, "/predicted_labels.csv"))
predicted_cell_labels_new <- subset(predicted_cell_labels, select = 'predicted_label')
colnames(predicted_cell_labels_new) = c("PENCIL_pred_label_cw_1_1")

# change label names to yes, no, rej
label_names = unique(predicted_cell_labels_new$PENCIL_pred_label_cw_1_1)
print(label_names)
predicted_cell_labels_new$PENCIL_pred_label_cw_1_1 <- gsub("1", "yes", predicted_cell_labels_new$PENCIL_pred_label_cw_1_1)
predicted_cell_labels_new$PENCIL_pred_label_cw_1_1 <- gsub("0", "no", predicted_cell_labels_new$PENCIL_pred_label_cw_1_1)
predicted_cell_labels_new$PENCIL_pred_label_cw_1_1 <- gsub("Rejected", "rej", predicted_cell_labels_new$PENCIL_pred_label_cw_1_1)

meta <- merged_seu_subset@meta.data
meta.new <- cbind(meta, predicted_cell_labels_new) # cell ID in PENCIL output does not match the original ones. But it is in the same order.
merged_seu_subset <- AddMetaData(merged_seu_subset, meta.new)
#merged_seu_subset@meta.data$PENCIL_pred_label = NULL
merged_seu_subset$PENCIL_pred_label_cw_1_1 <- factor(merged_seu_subset$PENCIL_pred_label_cw_1_1, levels = c("yes", "no", "rej"))

######### PENCIL result with class weights = 1:2
phenotype_name = 'ICBresponse2'
predicted_cell_labels = read.csv(paste0(PENCIL_result_dir, dataset, '_', sampleType_name, '_', cellType_of_interest,"/py/", phenotype_name, "/predicted_labels.csv"))
predicted_cell_labels_new <- subset(predicted_cell_labels, select = 'predicted_label')
colnames(predicted_cell_labels_new) = c("PENCIL_pred_label_cw_1_2")

# change label names to yes, no, rej
label_names = unique(predicted_cell_labels_new$PENCIL_pred_label_cw_1_2)
print(label_names)
predicted_cell_labels_new$PENCIL_pred_label_cw_1_2 <- gsub("1", "yes", predicted_cell_labels_new$PENCIL_pred_label_cw_1_2)
predicted_cell_labels_new$PENCIL_pred_label_cw_1_2 <- gsub("0", "no", predicted_cell_labels_new$PENCIL_pred_label_cw_1_2)
predicted_cell_labels_new$PENCIL_pred_label_cw_1_2 <- gsub("Rejected", "rej", predicted_cell_labels_new$PENCIL_pred_label_cw_1_2)

meta <- merged_seu_subset@meta.data
meta.new <- cbind(meta, predicted_cell_labels_new) # cell ID in PENCIL output does not match the original ones. But it is in the same order.
merged_seu_subset <- AddMetaData(merged_seu_subset, meta.new)
#merged_seu_subset@meta.data$PENCIL_pred_label = NULL
merged_seu_subset$PENCIL_pred_label_cw_1_2 <- factor(merged_seu_subset$PENCIL_pred_label_cw_1_2, levels = c("yes", "no", "rej"))


######### PENCIL result with the low to high variability gene order
phenotype_name = 'ICBresponse3'
predicted_cell_labels = read.csv(paste0(PENCIL_result_dir, dataset, '_', sampleType_name, '_', cellType_of_interest,"/py/", phenotype_name, "/predicted_labels.csv"))
predicted_cell_labels_new <- subset(predicted_cell_labels, select = 'predicted_label')
colnames(predicted_cell_labels_new) = c("PENCIL_pred_label_geneOrder_var_low2high")

# change label names to yes, no, rej
label_names = unique(predicted_cell_labels_new$PENCIL_pred_label_geneOrder_var_low2high)
print(label_names)
predicted_cell_labels_new$PENCIL_pred_label_geneOrder_var_low2high <- gsub("1", "yes", predicted_cell_labels_new$PENCIL_pred_label_geneOrder_var_low2high)
predicted_cell_labels_new$PENCIL_pred_label_geneOrder_var_low2high <- gsub("0", "no", predicted_cell_labels_new$PENCIL_pred_label_geneOrder_var_low2high)
predicted_cell_labels_new$PENCIL_pred_label_geneOrder_var_low2high <- gsub("Rejected", "rej", predicted_cell_labels_new$PENCIL_pred_label_geneOrder_var_low2high)

meta <- merged_seu_subset@meta.data
meta.new <- cbind(meta, predicted_cell_labels_new) # cell ID in PENCIL output does not match the original ones. But it is in the same order.
merged_seu_subset <- AddMetaData(merged_seu_subset, meta.new)
#merged_seu_subset@meta.data$PENCIL_pred_label = NULL
merged_seu_subset$PENCIL_pred_label_geneOrder_var_low2high <- factor(merged_seu_subset$PENCIL_pred_label_geneOrder_var_low2high, levels = c("yes", "no", "rej"))


######### PENCIL result with the low to high mean expression gene order
phenotype_name = 'ICBresponse4'
predicted_cell_labels = read.csv(paste0(PENCIL_result_dir, dataset, '_', sampleType_name, '_', cellType_of_interest,"/py/", phenotype_name, "/predicted_labels.csv"))
predicted_cell_labels_new <- subset(predicted_cell_labels, select = 'predicted_label')
colnames(predicted_cell_labels_new) = c("PENCIL_pred_label_geneOrder_exp_low2high")

# change label names to yes, no, rej
label_names = unique(predicted_cell_labels_new$PENCIL_pred_label_geneOrder_exp_low2high)
print(label_names)
predicted_cell_labels_new$PENCIL_pred_label_geneOrder_exp_low2high <- gsub("1", "yes", predicted_cell_labels_new$PENCIL_pred_label_geneOrder_exp_low2high)
predicted_cell_labels_new$PENCIL_pred_label_geneOrder_exp_low2high <- gsub("0", "no", predicted_cell_labels_new$PENCIL_pred_label_geneOrder_exp_low2high)
predicted_cell_labels_new$PENCIL_pred_label_geneOrder_exp_low2high <- gsub("Rejected", "rej", predicted_cell_labels_new$PENCIL_pred_label_geneOrder_exp_low2high)

meta <- merged_seu_subset@meta.data
meta.new <- cbind(meta, predicted_cell_labels_new) # cell ID in PENCIL output does not match the original ones. But it is in the same order.
merged_seu_subset <- AddMetaData(merged_seu_subset, meta.new)
#merged_seu_subset@meta.data$PENCIL_pred_label = NULL
merged_seu_subset$PENCIL_pred_label_geneOrder_exp_low2high <- factor(merged_seu_subset$PENCIL_pred_label_geneOrder_exp_low2high, levels = c("yes", "no", "rej"))


######### PENCIL result with the A to Z gene name gene order
phenotype_name = 'ICBresponse5'
predicted_cell_labels = read.csv(paste0(PENCIL_result_dir, dataset, '_', sampleType_name, '_', cellType_of_interest,"/py/", phenotype_name, "/predicted_labels.csv"))
predicted_cell_labels_new <- subset(predicted_cell_labels, select = 'predicted_label')
colnames(predicted_cell_labels_new) = c("PENCIL_pred_label_geneOrder_name_a2z")

# change label names to yes, no, rej
label_names = unique(predicted_cell_labels_new$PENCIL_pred_label_geneOrder_name_a2z)
print(label_names)
predicted_cell_labels_new$PENCIL_pred_label_geneOrder_name_a2z <- gsub("1", "yes", predicted_cell_labels_new$PENCIL_pred_label_geneOrder_name_a2z)
predicted_cell_labels_new$PENCIL_pred_label_geneOrder_name_a2z <- gsub("0", "no", predicted_cell_labels_new$PENCIL_pred_label_geneOrder_name_a2z)
predicted_cell_labels_new$PENCIL_pred_label_geneOrder_name_a2z <- gsub("Rejected", "rej", predicted_cell_labels_new$PENCIL_pred_label_geneOrder_name_a2z)

meta <- merged_seu_subset@meta.data
meta.new <- cbind(meta, predicted_cell_labels_new) # cell ID in PENCIL output does not match the original ones. But it is in the same order.
merged_seu_subset <- AddMetaData(merged_seu_subset, meta.new)
#merged_seu_subset@meta.data$PENCIL_pred_label = NULL
merged_seu_subset$PENCIL_pred_label_geneOrder_name_a2z <- factor(merged_seu_subset$PENCIL_pred_label_geneOrder_name_a2z, levels = c("yes", "no", "rej"))


# merged_seu_subset$PENCIL_pred_label_cw_1_1 = factor(merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_CW1, levels = c("yes", "no", "rej"))
# merged_seu_subset$PENCIL_pred_label_cw_1_2 = factor(merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_CW2, levels = c("yes", "no", "rej"))
# merged_seu_subset$PENCIL_pred_label_geneOrder_var_low2high <- factor(merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_geneOrder_revVariance, levels = c("yes", "no", "rej"))
# merged_seu_subset$PENCIL_pred_label_geneOrder_exp_low2high <- factor(merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_geneOrder_revGeneExp, levels = c("yes", "no", "rej"))
# merged_seu_subset$PENCIL_pred_label_geneOrder_name_a2z <- factor(merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_geneOrder_geneName, levels = c("yes", "no", "rej"))

saveRDS(object = merged_seu_subset, file = paste0(processed_dir, "seu_",sampleType_name,"_", cellType_of_interest, "_Feldman.rds")) 
```



# Add PENCIL identified phenotypic cell labels to seurat object (original 70% CD8T cells)
```{r}

# load seurat object
merged_seu_subset = readRDS(file = paste0(processed_dir,"seu_",sampleType_name,'_',cellType_of_interest,"_Feldman_0.7sample.rds"))

######### PENCIL result with class weights = 1:1
phenotype_name = 'ICBresponse6'
predicted_cell_labels = read.csv(paste0(PENCIL_result_dir, dataset, '_', sampleType_name, '_', cellType_of_interest,"/py/", phenotype_name, "/predicted_labels.csv"))
predicted_cell_labels_new <- subset(predicted_cell_labels, select = 'predicted_label')
colnames(predicted_cell_labels_new) = c("PENCIL_pred_label")

# change label names to yes, no, rej
label_names = unique(predicted_cell_labels_new$PENCIL_pred_label)
print(label_names)
predicted_cell_labels_new$PENCIL_pred_label <- gsub("1", "yes", predicted_cell_labels_new$PENCIL_pred_label)
predicted_cell_labels_new$PENCIL_pred_label <- gsub("0", "no", predicted_cell_labels_new$PENCIL_pred_label)
predicted_cell_labels_new$PENCIL_pred_label <- gsub("Rejected", "rej", predicted_cell_labels_new$PENCIL_pred_label)

meta <- merged_seu_subset@meta.data
meta.new <- cbind(meta, predicted_cell_labels_new) # cell ID in PENCIL output does not match the original ones. But it is in the same order.
merged_seu_subset <- AddMetaData(merged_seu_subset, meta.new)
#merged_seu_subset@meta.data$PENCIL_pred_label = NULL
merged_seu_subset$PENCIL_pred_label <- factor(merged_seu_subset$PENCIL_pred_label, levels = c("yes", "no", "rej"))


# merged_seu_subset$PENCIL_pred_label = factor(merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_0.7sample, levels = c("yes", "no", "rej"))

saveRDS(object = merged_seu_subset, file = paste0(processed_dir, "seu_",sampleType_name,"_", cellType_of_interest, "_Feldman_0.7sample.rds")) 

```


# Add PENCIL identified phenotypic cell labels to seurat object (celltypist CD8T cells)
```{r}

# load seurat object
merged_seu_subset = readRDS(file = paste0(processed_dir,"seu_",sampleType_name,'_',cellType_of_interest,"_celltypist.rds"))


######### PENCIL result with class weights = 1:1
phenotype_name = 'ICBresponse7'
predicted_cell_labels = read.csv(paste0(PENCIL_result_dir, dataset, '_', sampleType_name, '_', cellType_of_interest,"/py/", phenotype_name, "/predicted_labels.csv"))
predicted_cell_labels_new <- subset(predicted_cell_labels, select = 'predicted_label')
colnames(predicted_cell_labels_new) = c("PENCIL_pred_label")

# change label names to yes, no, rej
label_names = unique(predicted_cell_labels_new$PENCIL_pred_label)
print(label_names)
predicted_cell_labels_new$PENCIL_pred_label <- gsub("1", "yes", predicted_cell_labels_new$PENCIL_pred_label)
predicted_cell_labels_new$PENCIL_pred_label <- gsub("0", "no", predicted_cell_labels_new$PENCIL_pred_label)
predicted_cell_labels_new$PENCIL_pred_label <- gsub("Rejected", "rej", predicted_cell_labels_new$PENCIL_pred_label)


meta <- merged_seu_subset@meta.data
meta.new <- cbind(meta, predicted_cell_labels_new) # cell ID in PENCIL output does not match the original ones. But it is in the same order.
merged_seu_subset <- AddMetaData(merged_seu_subset, meta.new)
#merged_seu_subset@meta.data$PENCIL_pred_label = NULL
merged_seu_subset$PENCIL_pred_label <- factor(merged_seu_subset$PENCIL_pred_label, levels = c("yes", "no", "rej"))

# merged_seu_subset$PENCIL_pred_label = factor(merged_seu_subset$PENCIL_pred_label_celltypistCD8T, levels = c("yes", "no", "rej"))

saveRDS(object = merged_seu_subset, file = paste0(processed_dir, "seu_",sampleType_name,"_", cellType_of_interest, "_celltypist.rds")) 

```


# Add PENCIL identified phenotypic cell labels to seurat object (singler CD8T cells)
```{r}

# load seurat object
merged_seu_subset = readRDS(file = paste0(processed_dir,"seu_",sampleType_name,'_',cellType_of_interest,"_singler.rds"))


######### PENCIL result with class weights = 1:1
phenotype_name = 'ICBresponse8'
predicted_cell_labels = read.csv(paste0(PENCIL_result_dir, dataset, '_', sampleType_name, '_', cellType_of_interest,"/py/", phenotype_name, "/predicted_labels.csv"))
predicted_cell_labels_new <- subset(predicted_cell_labels, select = 'predicted_label')
colnames(predicted_cell_labels_new) = c("PENCIL_pred_label")

# change label names to yes, no, rej
label_names = unique(predicted_cell_labels_new$PENCIL_pred_label)
print(label_names)
predicted_cell_labels_new$PENCIL_pred_label <- gsub("1", "yes", predicted_cell_labels_new$PENCIL_pred_label)
predicted_cell_labels_new$PENCIL_pred_label <- gsub("0", "no", predicted_cell_labels_new$PENCIL_pred_label)
predicted_cell_labels_new$PENCIL_pred_label <- gsub("Rejected", "rej", predicted_cell_labels_new$PENCIL_pred_label)


meta <- merged_seu_subset@meta.data
meta.new <- cbind(meta, predicted_cell_labels_new) # cell ID in PENCIL output does not match the original ones. But it is in the same order.
merged_seu_subset <- AddMetaData(merged_seu_subset, meta.new)
#merged_seu_subset@meta.data$PENCIL_pred_label = NULL
merged_seu_subset$PENCIL_pred_label <- factor(merged_seu_subset$PENCIL_pred_label, levels = c("yes", "no", "rej"))

# merged_seu_subset$PENCIL_pred_label = factor(merged_seu_subset$PENCIL_pred_label_singlerCD8T, levels = c("yes", "no", "rej"))

saveRDS(object = merged_seu_subset, file = paste0(processed_dir, "seu_",sampleType_name,"_", cellType_of_interest, "_singler.rds")) 

```


# UMAP visualization of original CD8T cells
```{r}

merged_seu_subset = readRDS(file = paste0(processed_dir,"seu_",sampleType_name,'_',cellType_of_interest,"_Feldman.rds"))
phenotype_name = 'ResponseInfo'

merged_seu_subset <- FindVariableFeatures(object=merged_seu_subset, selection.method='vst', nfeatures=2000)
merged_seu_subset <- ScaleData(merged_seu_subset)
merged_seu_subset <- RunPCA(merged_seu_subset, pc.genes = merged_seu_subset@var.genes)
merged_seu_subset <- RunUMAP(merged_seu_subset, reduction = "pca", dims = 1:10)
merged_seu_subset <- FindNeighbors(merged_seu_subset, reduction = "pca", dims=1:10, k.param=20)
merged_seu_subset <- FindClusters(merged_seu_subset, resolution = 0.8)


merged_seu_subset$ResponseInfo <- factor(merged_seu_subset$ResponseInfo, levels = c(1,0))
merged_seu_subset$PENCIL_pred_label_cw_1_1 <- factor(merged_seu_subset$PENCIL_pred_label_cw_1_1, levels = c("yes", "no", "rej"))
merged_seu_subset$PENCIL_pred_label_cw_1_2 <- factor(merged_seu_subset$PENCIL_pred_label_cw_1_2, levels = c("yes", "no", "rej"))
merged_seu_subset$PENCIL_pred_label_geneOrder_var_low2high <- factor(merged_seu_subset$PENCIL_pred_label_geneOrder_var_low2high, levels = c("yes", "no", "rej"))
merged_seu_subset$PENCIL_pred_label_geneOrder_exp_low2high <- factor(merged_seu_subset$PENCIL_pred_label_geneOrder_exp_low2high, levels = c("yes", "no", "rej"))
merged_seu_subset$PENCIL_pred_label_geneOrder_name_a2z <- factor(merged_seu_subset$PENCIL_pred_label_geneOrder_name_a2z, levels = c("yes", "no", "rej"))


###### UMAP of true cell labels
DimPlot(merged_seu_subset, group.by = phenotype_name, pt.size = 0.1)+NoLegend() +
  scale_color_manual(values = c("orange", "purple"))+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_", sampleType_name,'_',cellType_of_interest, "_Feldman_",phenotype_name,".pdf"), height = 60*1.2, width = 60*1.2, units = "mm")
print(table(merged_seu_subset@meta.data[phenotype_name]))

###### UMAP of PENCIL predicted cell labels with class weights = 1:1
DimPlot(merged_seu_subset, group.by = "PENCIL_pred_label_cw_1_1", pt.size = 0.1)+NoLegend() +
  scale_color_manual(values = c("orange", "purple", "#D3D3D3"))+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_", sampleType_name,'_',cellType_of_interest, "_PENCILpredLabel_Feldman_CW1.pdf"), height = 60*1.2, width = 60*1.2, units = "mm")
print(table(merged_seu_subset$PENCIL_pred_label_cw_1_1))

###### UMAP of PENCIL predicted cell labels with class weights = 1:2
DimPlot(merged_seu_subset, group.by = "PENCIL_pred_label_cw_1_2", pt.size = 0.1)+NoLegend() +
  scale_color_manual(values = c("orange", "purple", "#D3D3D3"))+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_", sampleType_name,'_',cellType_of_interest, "_PENCILpredLabel_Feldman_CW2.pdf"), height = 60*1.2, width = 60*1.2, units = "mm")
print(table(merged_seu_subset$PENCIL_pred_label_cw_1_2))

###### UMAP of PENCIL predicted cell labels with gene order of low2high varibility
DimPlot(merged_seu_subset, group.by = "PENCIL_pred_label_geneOrder_var_low2high", pt.size = 0.1)+NoLegend() +
  scale_color_manual(values = c("orange", "purple", "#D3D3D3"))+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_", sampleType_name,'_',cellType_of_interest, "_PENCILpredLabel_Feldman_geneOrder_var_low2high.pdf"), height = 60*1.2, width = 60*1.2, units = "mm")
print(table(merged_seu_subset$PENCIL_pred_label_geneOrder_var_low2high))

###### UMAP of PENCIL predicted cell labels with gene order of low2high expression
DimPlot(merged_seu_subset, group.by = "PENCIL_pred_label_geneOrder_exp_low2high", pt.size = 0.1)+NoLegend() +
  scale_color_manual(values = c("orange", "purple", "#D3D3D3"))+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_", sampleType_name,'_',cellType_of_interest, "_PENCILpredLabel_Feldman_geneOrder_exp_low2high.pdf"), height = 60*1.2, width = 60*1.2, units = "mm")
print(table(merged_seu_subset$PENCIL_pred_label_geneOrder_exp_low2high))

###### UMAP of PENCIL predicted cell labels with gene order of a2z gene name
DimPlot(merged_seu_subset, group.by = "PENCIL_pred_label_geneOrder_name_a2z", pt.size = 0.1)+NoLegend() +
  scale_color_manual(values = c("orange", "purple", "#D3D3D3"))+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_", sampleType_name,'_',cellType_of_interest, "_PENCILpredLabel_Feldman_geneOrder_name_a2z.pdf"), height = 60*1.2, width = 60*1.2, units = "mm")
print(table(merged_seu_subset$PENCIL_pred_label_geneOrder_name_a2z))

```


# UMAP visualization of 70% original CD8T cells
```{r}

merged_seu_subset = readRDS(file = paste0(processed_dir,"seu_",sampleType_name,'_',cellType_of_interest,"_Feldman_0.7sample.rds"))
phenotype_name = 'ResponseInfo'

merged_seu_subset$ResponseInfo <- factor(merged_seu_subset$ResponseInfo, levels = c(1,0))
merged_seu_subset$PENCIL_pred_label <- factor(merged_seu_subset$PENCIL_pred_label, levels = c("yes", "no", "rej"))

###### UMAP of PENCIL predicted cell labels 
DimPlot(merged_seu_subset, group.by = "PENCIL_pred_label", pt.size = 0.1)+NoLegend() +
  scale_color_manual(values = c("orange", "purple", "#D3D3D3"))+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_", sampleType_name,'_',cellType_of_interest, "_PENCILpredLabel_Feldman_0.7sample.pdf"), height = 60*1.2, width = 60*1.2, units = "mm")
print(table(merged_seu_subset$PENCIL_pred_label))
```



# UMAP visualization of celltypist annotated CD8T cells
```{r}

merged_seu_subset = readRDS(file = paste0(processed_dir,"seu_",sampleType_name,'_',cellType_of_interest,"_celltypist.rds"))
phenotype_name = 'ResponseInfo'

merged_seu_subset$ResponseInfo <- factor(merged_seu_subset$ResponseInfo, levels = c(1,0))
merged_seu_subset$PENCIL_pred_label <- factor(merged_seu_subset$PENCIL_pred_label, levels = c("yes", "no", "rej"))

###### UMAP of PENCIL predicted cell labels 
DimPlot(merged_seu_subset, group.by = "PENCIL_pred_label", pt.size = 0.1)+NoLegend() +
  scale_color_manual(values = c("orange", "purple", "#D3D3D3"))+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_", sampleType_name,'_',cellType_of_interest, "_PENCILpredLabel_celltypist.pdf"), height = 60*1.2, width = 60*1.2, units = "mm")
print(table(merged_seu_subset$PENCIL_pred_label))
```


# UMAP visualization of singler annotated CD8T cells
```{r}

merged_seu_subset = readRDS(file = paste0(processed_dir,"seu_",sampleType_name,'_',cellType_of_interest,"_singler.rds"))
phenotype_name = 'ResponseInfo'

merged_seu_subset$ResponseInfo <- factor(merged_seu_subset$ResponseInfo, levels = c(1,0))
merged_seu_subset$PENCIL_pred_label <- factor(merged_seu_subset$PENCIL_pred_label, levels = c("yes", "no", "rej"))

###### UMAP of PENCIL predicted cell labels 
DimPlot(merged_seu_subset, group.by = "PENCIL_pred_label", pt.size = 0.1)+NoLegend() +
  scale_color_manual(values = c("orange", "purple", "#D3D3D3"))+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_", sampleType_name,'_',cellType_of_interest, "_PENCILpredLabel_singler.pdf"), height = 60*1.2, width = 60*1.2, units = "mm")
print(table(merged_seu_subset$PENCIL_pred_label))
```


