---
title: "Pre-process the data for PENCIL input"
author: "Tiangen Chang tiangen.chang@nih.gov"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r}
# clear all objects including hidden objects
rm(list = ls(all.names = TRUE)) 
# free up memory and report the memory usage
gc()
```


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment = FALSE, 
                      warning = FALSE, 
                      message = FALSE)
require(ggplot2)
ggplot2::theme_set(new = theme_bw(base_size = 12)) # sets the theme and axis font size
```

# Connect to server
```{bash}
ssh changt7@biowulf.nih.gov
sinteractive --mem=64g --cpus-per-task=32 --time=24:00:00
sinteractive --mem=128g --cpus-per-task=32 --gres=gpu:k80:2 --time=24:00:00
# --gres=lscratch:1024
module load R/
R

```

# load required package
```{r, include=FALSE}
#if (!require("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
#BiocManager::install("UCell")
library(UCell)

#devtools::install_github("mojaveazure/seurat-disk")
#devtools::install_github('satijalab/seurat-data')
library(SeuratData)
library(SeuratDisk)

library(caret)
library(Seurat)
library(GEOquery)
library(dplyr)
library(ggplot2)
library(SingleR)
library(sctransform)
library(celldex)
library(dittoSeq)
library(SeuratWrappers)
library(harmony)
library(scuttle)
library(scran)
library(scFeatureFilter)
library(cowplot)
library(patchwork)
library(edgeR)
library(RColorBrewer)
library(stringr)

```

# set input and output directories & parameters
```{r}

dataset = 'GSE120575' # 'GSE200996'   'GSE120575'   'GSE169246'

# local
data_dir <- paste0("/Users/changt7/Documents/00.PostDocWork/CancerResearch/01.Projects/00.Collaborating_projects/05.PENCIL/02.Input/", dataset, '/')
processed_dir <- paste0("../03.Results/", dataset, '/')
fig_dir <- paste0("../03.Results/", dataset, '/Figures/')

# server
shared_data_dir = paste0("/data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/02.Input/")
data_dir <- paste0(shared_data_dir, dataset, '/')
processed_dir <- paste0("/data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/", dataset, '/')
fig_dir = paste0("/data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/", dataset, "/Figures/")
PENCIL_result_dir = paste0("/data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/01.Scripts/results/")
```

# load raw seurat object
```{r}

sampleType_name = 'Tissue' # 'merged_seu'  'Tissue'

merged_seu = readRDS(file = paste0(data_dir,"seu_",sampleType_name,"_all_raw.rds"))

```


# Normalize, scale and annotate for T, B and myloid cells
```{r}

# filter genes to keep only protein coding genes
protein_coding_gene_file = paste0(shared_data_dir, 'Feldman_protein_coding_genes.csv')
protein_coding_genes=read.csv(protein_coding_gene_file, header=T)[,1]
genes <- intersect(protein_coding_genes, row.names(merged_seu))
merged_seu <- merged_seu[genes, ]

# Normalization, scaling, dimension reduction, and clustering
merged_seu <- NormalizeData(object=merged_seu, normalization.method="LogNormalize")
merged_seu <- FindVariableFeatures(object=merged_seu, selection.method='vst', nfeatures=2000)
merged_seu <- ScaleData(object=merged_seu)
merged_seu <- RunPCA(object=merged_seu, features=VariableFeatures(merged_seu))
merged_seu <- FindNeighbors(object=merged_seu, dims=1:10, k.param=20)
merged_seu <- FindClusters(object=merged_seu, resolution=1.6)
merged_seu <- RunUMAP(object=merged_seu, dims=1:10)

# save for .h5ad as celltypist's input
SaveH5Seurat(merged_seu, filename = paste0(processed_dir,"seu_",sampleType_name,"_all.h5Seurat"), overwrite = TRUE)
Convert(paste0(processed_dir,"seu_",sampleType_name,"_all.h5Seurat"), dest = "h5ad", assay = "RNA", overwrite = TRUE) # .X: only scaled data for HVGs. .raw.X: all genes 
saveRDS(object = merged_seu, file = paste0(processed_dir,"seu_",sampleType_name,"_all.rds")) 

```


# celltypist annotation
```{bash}

celltypist --indata /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/seu_Tissue_all.h5ad --model Immune_All_Low.pkl --outdir /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/ --prefix Tissue_all_celltypist_ImmuneAllLow_

```

# add cell type annotation to seurat object
```{r}

cell_types_to_keep = c("CD8T-cells", "CD4T-cells", "B-cells")
confidence_cutoff = 0.1 #  set cell labels to "NA" if confidence below confidence_cutoff (about 6% cells having conf < 0.1)

prediction_labels <- read.csv(paste0(processed_dir, sampleType_name,"_all_celltypist_ImmuneAllLow_predicted_labels.csv"), row.names = 1)
prediction_prob <- read.csv(paste0(processed_dir, sampleType_name,"_all_celltypist_ImmuneAllLow_probability_matrix.csv"), row.names = 1)
prediction_prob_max = data.frame(max_value = apply(prediction_prob, 1, max, na.rm = TRUE))
colnames(prediction_prob_max) = c('probability')
prediction_labels_prob <- cbind(prediction_labels[c('predicted_labels')], prediction_prob_max[c('probability')])

merged_seu$cell_type_celltypist_raw <- prediction_labels_prob$predicted_labels
merged_seu$cell_type_celltypist_raw_prob <- prediction_labels_prob$probability

merged_seu$cell_type_celltypist = merged_seu$cell_type_celltypist_raw
merged_seu$cell_type_celltypist <- ifelse(grepl("CD8|cytotoxic T|MAIT", merged_seu$cell_type_celltypist, ignore.case = FALSE), "CD8T-cells", merged_seu$cell_type_celltypist)
merged_seu$cell_type_celltypist <- ifelse(grepl("CD4+|helper T|Treg|Regulatory T", merged_seu$cell_type_celltypist, ignore.case = FALSE), "CD4T-cells", merged_seu$cell_type_celltypist)
merged_seu$cell_type_celltypist <- ifelse(grepl("B cells|Plasma cells|Plasmablasts", merged_seu$cell_type_celltypist, ignore.case = FALSE), "B-cells", merged_seu$cell_type_celltypist)
if (length(unique(merged_seu$cell_type_celltypist)) > length(cell_types_to_keep)){
  merged_seu$cell_type_celltypist <- recode(merged_seu$cell_type_celltypist, !!!setNames(rep("Other", length(setdiff(unique(merged_seu$cell_type_celltypist), cell_types_to_keep))), setdiff(unique(merged_seu$cell_type_celltypist), cell_types_to_keep)))
}
merged_seu$cell_type_celltypist[merged_seu$cell_type_celltypist_raw_prob < confidence_cutoff] = "Other"

```


# cell annotation using singler
```{r}
confidence_cutoff = 0.4 # set cell labels to NA if confidence below confidence_cutoff (about 6% cells having conf < 0.4)

# cell annotation using BlueprintEncodeData. This reference only contains "naive B-cells", "Memory B-cells" and "Plasma cells". No other B cell types.
cellType_anno_fn = paste0(processed_dir, sampleType_name,"_singleR_BlueprintEncodeData_predicted_labels.csv")
if(file.exists(cellType_anno_fn)){
  singler.anno1 <- read.csv(cellType_anno_fn, row.names = 1)
} else {
  ref1 <- celldex::BlueprintEncodeData()
  singleR <- as.SingleCellExperiment(merged_seu, assay= "RNA") 
  singler.anno1 <- SingleR(test = singleR, ref = ref1, labels = (ref1$label.main)) # label.main
  write.csv(singler.anno1, file = cellType_anno_fn, row.names = TRUE)
}
cell_labelsProb_df <- data.frame(max_value = apply(singler.anno1$scores, 1, max, na.rm = TRUE))
cell_labels_df = cbind(singler.anno1$labels, cell_labelsProb_df)
colnames(cell_labels_df) = c('predicted_labels', 'probability')

merged_seu$cell_type_ENCODE_raw <- cell_labels_df$predicted_labels
merged_seu$cell_type_ENCODE_raw_prob <- cell_labels_df$probability

merged_seu$cell_type_ENCODE <- merged_seu$cell_type_ENCODE_raw
merged_seu$cell_type_ENCODE <- ifelse(grepl("CD4+|Tregs", merged_seu$cell_type_ENCODE, ignore.case = TRUE), "CD4T-cells", merged_seu$cell_type_ENCODE)
merged_seu$cell_type_ENCODE <- ifelse(grepl("CD8+", merged_seu$cell_type_ENCODE, ignore.case = TRUE), "CD8T-cells", merged_seu$cell_type_ENCODE)
merged_seu$cell_type_ENCODE <- ifelse(grepl("B-cells|Plasma cells", merged_seu$cell_type_ENCODE, ignore.case = TRUE), "B-cells", merged_seu$cell_type_ENCODE)
if (length(unique(merged_seu$cell_type_ENCODE)) > length(cell_types_to_keep)){
  merged_seu$cell_type_ENCODE <- recode(merged_seu$cell_type_ENCODE, !!!setNames(rep("Other", length(setdiff(unique(merged_seu$cell_type_ENCODE), cell_types_to_keep))), setdiff(unique(merged_seu$cell_type_ENCODE), cell_types_to_keep)))
}
merged_seu$cell_type_ENCODE[merged_seu$cell_type_ENCODE_raw_prob < confidence_cutoff] = "Other"

```


# (Optional) Assigning cell types to clusters 
```{r}

cellTypeProp_cutoff = 0 

tab <- table(merged_seu$seurat_clusters, merged_seu$cell_type_celltypist_raw)
tab <- sweep(tab, MARGIN = 1, STATS = rowSums(tab), FUN = "/")
cluster_cellType_df <- data.frame(cell_type_celltypist = apply(tab, 1, function(x) {
  max_value = max(x)
  if (max_value >= cellTypeProp_cutoff) {
    return(names(x)[which.max(x)])
  } else {
    return("mixture")
  }
}))
cluster_cellType_df$seurat_cluster = rownames(tab)

mapping <- setNames(object = cluster_cellType_df$cell_type_celltypist, nm = cluster_cellType_df$seurat_cluster)

merged_seu$cell_type_celltypist_cluster <- mapping[merged_seu$seurat_clusters]

saveRDS(object = merged_seu, file = paste0(processed_dir,"seu_",sampleType_name,"_all.rds")) 

```


# UMAP cell type Plot 
```{r}

DimPlot(merged_seu, group.by = "cell_type_celltypist_cluster", label = TRUE, repel = TRUE, raster=FALSE)+NoLegend()+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_",sampleType_name,"_all_cellType.png"), height = 120, width = 140, dpi = 800, units = "mm")

DimPlot(merged_seu, group.by = "cell_type_originalCD8T", label = TRUE, repel = TRUE, raster=FALSE)+NoLegend()+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_",sampleType_name,"_all_cellType_originalCD8T.png"), height = 120, width = 140, dpi = 800, units = "mm")

DimPlot(merged_seu, group.by = "cell_type_customCD8T", label = TRUE, repel = TRUE, raster=FALSE)+NoLegend()+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_",sampleType_name,"_all_cellType_customCD8T.png"), height = 120, width = 140, dpi = 800, units = "mm")

```

# subset seurat to focus on cell types of interest (e.g. T, CD8T, B, ...)
```{r}

#merged_seu = readRDS(file = paste0(processed_dir,"seu_",sampleType_name,"_all.rds"))

phenotype_name = 'ResponseInfo' # GSE200996: 'Any_response'; GSE120575: 'ResponseInfo'
cellType_of_interest = 'CD8T' # 'CD8T'  'CD4T'  'B' 'T'

if (cellType_of_interest == 'T'){
  merged_seu_subset <- subset(merged_seu, subset = cell_type_celltypist_cluster %in% c("T-cells"))
}else if (cellType_of_interest == 'CD8T'){
  merged_seu_subset <- subset(merged_seu, subset = cell_type_originalCD8T %in% c("CD8+ T-cells"))
  #merged_seu_subset <- subset(merged_seu, subset = cell_type_celltypist %in% c("CD8T-cells"))
  #merged_seu_subset <- subset(merged_seu, subset = cell_type_ENCODE %in% c("CD8T-cells"))
}else if (cellType_of_interest == 'B'){
  merged_seu_subset <- subset(merged_seu, subset = cell_type_celltypist_cluster %in% c("B-cells"))
}else if (cellType_of_interest == 'Myeloid'){
  merged_seu_subset <- subset(merged_seu, subset = cell_type_celltypist_cluster %in% c("Myeloid-cells"))
}

print(merged_seu_subset)

merged_seu_subset <- FindVariableFeatures(object=merged_seu_subset, selection.method='vst', nfeatures=2000)
merged_seu_subset <- ScaleData(merged_seu_subset)

### 70%:30% train:test split
merged_seu_subset_train = subset(merged_seu_subset, subset = meta_train %in% c(1))
merged_seu_subset_test = subset(merged_seu_subset, subset = meta_train %in% c(0))

### leave one out CV
#merged_seu_subset_train = subset(merged_seu_subset, subset = meta != 'Post_P5_2')

### already normalized for all cells
#merged_seu_subset_train <- NormalizeData(object=merged_seu_subset_train, normalization.method="LogNormalize")
merged_seu_subset_train <- FindVariableFeatures(object=merged_seu_subset_train, selection.method='vst', nfeatures=2000)
merged_seu_subset_train <- ScaleData(merged_seu_subset_train)

merged_seu_subset_train <- RunPCA(merged_seu_subset_train, pc.genes = merged_seu_subset_train@var.genes)
merged_seu_subset_train <- RunUMAP(merged_seu_subset_train, reduction = "pca", dims = 1:10)
merged_seu_subset_train <- FindNeighbors(merged_seu_subset_train, reduction = "pca", dims=1:10, k.param=20)
merged_seu_subset_train <- FindClusters(merged_seu_subset_train, resolution = 0.8)

### save to .h5ad for PENCIL to read: PENCIL does not work well with .h5ad file
#SaveH5Seurat(merged_seu_subset_train, filename = paste0(processed_dir, "seu_",sampleType_name,"_", cellType_of_interest, ".h5Seurat"), overwrite = TRUE)
#Convert(paste0(processed_dir, "seu_",sampleType_name,"_", cellType_of_interest, ".h5Seurat"), dest = "h5ad", assay = "RNA", overwrite = TRUE) # .X: only scaled data for HVGs. .raw.X: all genes 
#saveRDS(object = merged_seu_subset_train, file = paste0(processed_dir, "seu_",sampleType_name,"_", cellType_of_interest, ".rds")) 

# save to csv, another format of input for PENCIL
# save all data

merged_seu_subset = merged_seu_subset0

### default gene order by variance (high to low)
variable_genes <- VariableFeatures(merged_seu_subset)
### reversed order by variance (low to high)
reversed_genes <- rev(variable_genes)
### order by gene name
variable_genes_OrderByName = sort(variable_genes)

### order by mean expression
variable_expression <- merged_seu_subset@assays[['RNA']]@data[variable_genes, ]
mean_expression <- rowMeans(variable_expression)
mean_expression_df <- data.frame(gene = rownames(variable_expression), mean_expression)
ranked_genes <- mean_expression_df[order(mean_expression_df$mean_expression, decreasing = TRUE), ]
ranked_genes_high2low = ranked_genes$gene
### reverse
ranked_genes <- mean_expression_df[order(mean_expression_df$mean_expression, decreasing = F), ]
ranked_genes_low2high = ranked_genes$gene

merged_seu_subset = subset(merged_seu_subset, subset = meta_train %in% c(1))
merged_seu_subset <- FindVariableFeatures(object=merged_seu_subset, selection.method='vst', nfeatures=2000)
merged_seu_subset <- ScaleData(merged_seu_subset)

exp_data_scaled = merged_seu_subset@assays[["RNA"]]@scale.data[variable_genes,]
write.csv(exp_data_scaled, file=paste0(processed_dir,"seu_",sampleType_name,'_',cellType_of_interest,".csv"))
cell_label_df = data.frame(label = merged_seu_subset$ResponseInfo)
write.csv(cell_label_df, file=paste0(processed_dir,"cell_label_info.csv"))
emd = merged_seu_subset@reductions[["umap"]]@cell.embeddings
write.csv(emd, file=paste0(processed_dir, "seu_",sampleType_name,'_',cellType_of_interest,'_embedding_umap.csv'))

# save train data
exp_data_scaled = merged_seu_subset_train@assays[["RNA"]]@scale.data[VariableFeatures(merged_seu_subset_train),]
write.csv(exp_data_scaled, file=paste0(processed_dir,"seu_",sampleType_name,'_',cellType_of_interest,"_Train.csv"))
cell_label_df = data.frame(label = merged_seu_subset_train$ResponseInfo)
write.csv(cell_label_df, file=paste0(processed_dir,"cell_label_info_Train.csv"))
emd = merged_seu_subset_train@reductions[["umap"]]@cell.embeddings
write.csv(emd, file=paste0(processed_dir, "seu_",sampleType_name,'_',cellType_of_interest,'_Train_embedding_umap.csv'))

# save test data
exp_data = as.matrix(merged_seu_subset_train@assays[["RNA"]]@data[VariableFeatures(merged_seu_subset_train),])
exp_data_scale_t = scale(t(exp_data))
center <- attr(exp_data_scale_t, "scaled:center")
scale <- attr(exp_data_scale_t,"scaled:scale")
exp_data_new = as.matrix(merged_seu_subset_test@assays[["RNA"]]@data[VariableFeatures(merged_seu_subset_test),])
exp_data_new_scale_t = scale(t(exp_data_new), center=center, scale=scale)
exp_data_new_scale <- t(exp_data_new_scale_t)
write.csv(exp_data_new_scale, file=paste0(processed_dir,"seu_",sampleType_name,'_',cellType_of_interest,"_Test.csv"))


saveRDS(object = merged_seu_subset, file = paste0(processed_dir, "seu_",sampleType_name,"_", cellType_of_interest, ".rds")) 

```

# Run PENCIL
```{bash}

## one must use gpu to accelerate running PENCIL, otherwise would be extremely slow
sinteractive --mem=128g --cpus-per-task=32 --gres=gpu:k80:2 --time=24:00:00
## PENCIL has been installed in python/3.8
module load python/3.8

## Run PENCIL with .h5ad file as input, which now does not work stably
#python 02.Run_PENCIL.py /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE200996/seu_Tissue_CD8Tcell.h5ad Any_response GSE200996_CD8T multi-classification 1 0

## Run PENCIL with .csv files as input, which seems work well
python 02.Run_PENCIL_csv.py /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/seu_Tissue_CD8T.csv /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/cell_label_info.csv /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/seu_Tissue_CD8T_embedding_umap.csv GSE120575_Tissue_CD8T ResponseInfo multi-classification  /data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/GSE120575/seu_Tissue_CD8T_Test.csv

## Remark for different modes of PENCIL
# classification mode
#exp_data = merged_seu@assays[["RNA"]]@scale.data[VariableFeatures(merged_seu),]
# regression mode
#exp_data = as.matrix(merged_seu@assays[["RNA"]]@counts)

```


# Add PENCIL identified phenotypic cell labels 
```{r}

# load seurat object
#merged_seu_subset = readRDS(file = paste0(data_dir,"seu_",sampleType_name,'_',cellType_of_interest,".rds"))


predicted_cell_labels = read.csv(paste0(PENCIL_result_dir, dataset, '_', sampleType_name, '_', cellType_of_interest,"/py/", phenotype_name, "/predicted_labels.csv"))
predicted_cell_labels_new <- subset(predicted_cell_labels, select = 'predicted_label')
colnames(predicted_cell_labels_new) = c("PENCIL_pred_label_singlerCD8T")

# change label names to yes, no, rej
label_names = unique(predicted_cell_labels_new$PENCIL_pred_label_singlerCD8T)
print(label_names)
predicted_cell_labels_new$PENCIL_pred_label_singlerCD8T <- gsub("1", "yes", predicted_cell_labels_new$PENCIL_pred_label_singlerCD8T)
predicted_cell_labels_new$PENCIL_pred_label_singlerCD8T <- gsub("0", "no", predicted_cell_labels_new$PENCIL_pred_label_singlerCD8T)
predicted_cell_labels_new$PENCIL_pred_label_singlerCD8T <- gsub("Rejected", "rej", predicted_cell_labels_new$PENCIL_pred_label_singlerCD8T)


meta <- merged_seu_subset@meta.data
meta.new <- cbind(meta, predicted_cell_labels_new) # cell ID in PENCIL output does not match the original ones. But it is in the same order.
merged_seu_subset <- AddMetaData(merged_seu_subset, meta.new)
#merged_seu_subset@meta.data$PENCIL_pred_label = NULL
merged_seu_subset$PENCIL_pred_label_singlerCD8T <- factor(merged_seu_subset$PENCIL_pred_label_singlerCD8T, levels = c("yes", "no", "rej"))


saveRDS(object = merged_seu_subset, file = paste0(processed_dir, "seu_",sampleType_name,"_", cellType_of_interest, "_Feldman.rds")) 

saveRDS(object = merged_seu_subset, file = paste0(processed_dir, "seu_",sampleType_name,"_", cellType_of_interest, "_Feldman_0.7sample.rds")) 

saveRDS(object = merged_seu_subset, file = paste0(processed_dir, "seu_",sampleType_name,"_", cellType_of_interest, "_celltypist.rds")) 

saveRDS(object = merged_seu_subset, file = paste0(processed_dir, "seu_",sampleType_name,"_", cellType_of_interest, "_singler.rds")) 

```

# statistics of predicted cell counts and UMAP visualization 
```{r}

merged_seu_subset0 = merged_seu_subset

merged_seu_subset = merged_seu_subset0



merged_seu_subset <- RunPCA(merged_seu_subset, pc.genes = merged_seu_subset@var.genes)
merged_seu_subset <- RunUMAP(merged_seu_subset, reduction = "pca", dims = 1:10)

#merged_seu_subset$ResponseInfo <- factor(merged_seu_subset$ResponseInfo, levels = c(1,0))
#merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_CW2 <- factor(merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_CW2, levels = c("yes", "no", "rej"))
#merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_CW1 <- factor(merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_CW1, levels = c("yes", "no", "rej"))
#merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_CW4301_to_2049 <- factor(merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_CW4301_to_2049, levels = c("yes", "no", "rej"))
#merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_geneOrder_revVariance <- factor(merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_geneOrder_revVariance, levels = c("yes", "no", "rej"))
#merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_geneOrder_geneExp <- factor(merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_geneOrder_geneExp, levels = c("yes", "no", "rej"))
#merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_geneOrder_revGeneExp <- factor(merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_geneOrder_revGeneExp, levels = c("yes", "no", "rej"))
#merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_geneOrder_geneName <- factor(merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_geneOrder_geneName, levels = c("yes", "no", "rej"))


#### PENCIL is sensitive to the class_weights (cw) parameter setting
DimPlot(merged_seu_subset, group.by = phenotype_name, pt.size = 0.1)+NoLegend() +
  scale_color_manual(values = c("forestgreen", "firebrick"))+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_", sampleType_name,'_',cellType_of_interest, "_Feldman_",phenotype_name,".pdf"), height = 60*1.2, width = 60*1.2, units = "mm")
print(table(merged_seu_subset@meta.data[phenotype_name]))

DimPlot(merged_seu_subset, group.by = "PENCIL_pred_label_FeldmanCD8T_CW2", pt.size = 0.1)+NoLegend() +
  scale_color_manual(values = c("forestgreen", "firebrick", "#333333"))+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_", sampleType_name,'_',cellType_of_interest, "_PENCILpredLabel_Feldman_CW2.pdf"), height = 60*1.2, width = 60*1.2, units = "mm")
print(table(merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_CW2))

DimPlot(merged_seu_subset, group.by = "PENCIL_pred_label_FeldmanCD8T_CW1", pt.size = 0.1)+NoLegend() +
  scale_color_manual(values = c("forestgreen", "firebrick", "#333333"))+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_", sampleType_name,'_',cellType_of_interest, "_PENCILpredLabel_Feldman_CW1.pdf"), height = 60*1.2, width = 60*1.2, units = "mm")
print(table(merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_CW1))

DimPlot(merged_seu_subset, group.by = "PENCIL_pred_label_FeldmanCD8T_CW4301_to_2049", pt.size = 0.1)+NoLegend() +
  scale_color_manual(values = c("forestgreen", "firebrick", "#333333"))+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_", sampleType_name,'_',cellType_of_interest, "_PENCILpredLabel_Feldman_CW4301_to_2049.pdf"), height = 60*1.2, width = 60*1.2, units = "mm")
print(table(merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_CW4301_to_2049))


#### PENCIL is sensitive to input gene order
DimPlot(merged_seu_subset, group.by = "PENCIL_pred_label_FeldmanCD8T_geneOrder_revVariance", pt.size = 0.1)+NoLegend() +
  scale_color_manual(values = c("forestgreen", "firebrick", "#333333"))+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_", sampleType_name,'_',cellType_of_interest, "_PENCILpredLabel_Feldman_geneOrder_revVariance.pdf"), height = 60*1.2, width = 60*1.2, units = "mm")
print(table(merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_geneOrder_revVariance))

DimPlot(merged_seu_subset, group.by = "PENCIL_pred_label_FeldmanCD8T_geneOrder_geneExp", pt.size = 0.1)+NoLegend() +
  scale_color_manual(values = c("forestgreen", "firebrick", "#333333"))+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_", sampleType_name,'_',cellType_of_interest, "_PENCILpredLabel_Feldman_geneOrder_geneExp.pdf"), height = 60*1.2, width = 60*1.2, units = "mm")
print(table(merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_geneOrder_geneExp))

DimPlot(merged_seu_subset, group.by = "PENCIL_pred_label_FeldmanCD8T_geneOrder_revGeneExp", pt.size = 0.1)+NoLegend() +
  scale_color_manual(values = c("forestgreen", "firebrick", "#333333"))+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_", sampleType_name,'_',cellType_of_interest, "_PENCILpredLabel_Feldman_geneOrder_revGeneExp.pdf"), height = 60*1.2, width = 60*1.2, units = "mm")
print(table(merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_geneOrder_revGeneExp))

DimPlot(merged_seu_subset, group.by = "PENCIL_pred_label_FeldmanCD8T_geneOrder_geneName", pt.size = 0.1)+NoLegend() +
  scale_color_manual(values = c("forestgreen", "firebrick", "#333333"))+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_", sampleType_name,'_',cellType_of_interest, "_PENCILpredLabel_Feldman_geneOrder_geneName.pdf"), height = 60*1.2, width = 60*1.2, units = "mm")
print(table(merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_geneOrder_geneName))


#### PENCIL is sensitive to input cells
DimPlot(merged_seu_subset, group.by = "PENCIL_pred_label_FeldmanCD8T_0.7sample", pt.size = 0.1)+NoLegend() +
  scale_color_manual(values = c("forestgreen", "firebrick", "#333333"))+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_", sampleType_name,'_',cellType_of_interest, "_PENCILpredLabel_Feldman_0.7sample.pdf"), height = 60*1.2, width = 60*1.2, units = "mm")
print(table(merged_seu_subset$PENCIL_pred_label_FeldmanCD8T_0.7sample))

DimPlot(merged_seu_subset, group.by = "PENCIL_pred_label_celltypistCD8T", pt.size = 0.1)+NoLegend() +
  scale_color_manual(values = c("forestgreen", "firebrick", "#333333"))+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_", sampleType_name,'_',cellType_of_interest, "_PENCILpredLabel_celltypist.pdf"), height = 60*1.2, width = 60*1.2, units = "mm")
print(table(merged_seu_subset$PENCIL_pred_label_celltypistCD8T))

DimPlot(merged_seu_subset, group.by = "PENCIL_pred_label_singlerCD8T", pt.size = 0.1)+NoLegend() +
  scale_color_manual(values = c("forestgreen", "firebrick", "#333333"))+
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_", sampleType_name,'_',cellType_of_interest, "_PENCILpredLabel_singler.pdf"), height = 60*1.2, width = 60*1.2, units = "mm")
print(table(merged_seu_subset$PENCIL_pred_label_singlerCD8T))





#### test original UMAP from all cells
DimPlot(merged_seu_subset, group.by = 'seurat_clusters', pt.size = 0.1)+NoLegend() +
  ggtitle("")
ggsave(filename = paste0(fig_dir, "UMAP_", sampleType_name,'_',cellType_of_interest, "_Feldman_cluster.pdf"), height = 60*1.2, width = 60*1.2, units = "mm")
print(table(merged_seu_subset$seurat_clusters))

```


