---
title: "Pre-process the data for PENCIL input"
author: "Tiangen Chang tiangen.chang@nih.gov"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r}
# clear all objects including hidden objects
rm(list = ls(all.names = TRUE)) 
# free up memory and report the memory usage
gc()
```


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      comment = FALSE, 
                      warning = FALSE, 
                      message = FALSE)
require(ggplot2)
ggplot2::theme_set(new = theme_bw(base_size = 12)) # sets the theme and axis font size
```

# Connect to server
```{bash}
ssh changt7@biowulf.nih.gov
sinteractive --mem=64g --cpus-per-task=32 --time=24:00:00
sinteractive --mem=128g --cpus-per-task=32 --gres=gpu:k80:2 --time=24:00:00
# --gres=lscratch:1024
module load R/
R

```

# load required package
```{r, include=FALSE}
#if (!require("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
#BiocManager::install("UCell")
library(UCell)

#devtools::install_github("mojaveazure/seurat-disk")
#devtools::install_github('satijalab/seurat-data')
library(SeuratData)
library(SeuratDisk)

library(caret)
library(Seurat)
library(GEOquery)
library(dplyr)
library(ggplot2)
library(SingleR)
library(sctransform)
library(celldex)
library(dittoSeq)
library(SeuratWrappers)
library(harmony)
library(scuttle)
library(scran)
library(scFeatureFilter)
library(cowplot)
library(patchwork)
library(edgeR)
library(RColorBrewer)
library(stringr)
#library(clusterProfiler)
library(org.Hs.eg.db)

library(ReactomePA)
library(enrichplot)
library(gridExtra)

```

# set input and output directories & parameters
```{r}

phenotype_name = 'Tumor'

# server
shared_data_dir = paste0("/data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/02.Input/")
PENCIL_result_dir = paste0("/data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/01.Scripts/results/")
PENCIL_result_dir_deep = paste0(PENCIL_result_dir, 'GSE139324_all_CD8T/py/Tumor/')

dataset_train = 'GSE139324'
processed_dir_train <- paste0("/data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/", dataset_train, '/')
fig_dir_train = paste0("/data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/", dataset_train, "/Figures/")

dataset_test1 = 'GSE164690'
processed_dir_test1 <- paste0("/data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/", dataset_test1, '/')
fig_dir_test1 = paste0("/data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/", dataset_test1, "/Figures/")

dataset_test2 = 'GSE162025'
processed_dir_test2 <- paste0("/data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/", dataset_test2, '/')
fig_dir_test2 = paste0("/data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/", dataset_test2, "/Figures/")

dataset_test3 = 'GSE200996'
processed_dir_test3 <- paste0("/data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/", dataset_test3, '/')
fig_dir_test3 = paste0("/data/Lab_ruppin/tiangen/CancerProject/02.PENCIL/03.Results/", dataset_test3, "/Figures/")

```


# Identify DEGs for PENCIL N/NR cells on training data
```{r}

logFCfilter = 0.25 # 0.5
adjPvalFilter = 0.05

# loading seurat object of training data
merged_seu = readRDS(file = paste0(processed_dir_train,"seu_all_CD8T_PENCIL.rds"))

##### find all markers for PENCIL predicted labels
Idents(object = merged_seu) <- merged_seu@meta.data$'PENCIL_pred_label_tissue'
Cells.markers = FindAllMarkers(merged_seu, only.pos=T, min.pct=0.25, logfc.threshold = logFCfilter)
Idents(object = merged_seu) <- merged_seu@meta.data$'seurat_clusters'

sig.markers = Cells.markers[(abs(as.numeric(as.vector(Cells.markers$avg_log2FC))) > logFCfilter & 
                               as.numeric(as.vector(Cells.markers$p_val_adj)) < adjPvalFilter), ]

write.csv(sig.markers, paste0(processed_dir, "sig.markers_PENCILpredLabel_",sampleType_name, '_', cellType_of_interest,".csv"))

##### Keep only the top N genes for each PENCIL predicted label, ranked by logFC
tumor_markerGenes = sig.markers$gene[sig.markers$cluster=='yes']
PBMC_markerGenes = sig.markers$gene[sig.markers$cluster=='no']

tumor_markerGene_ids <- mapIds(org.Hs.eg.db, keys = tumor_markerGenes, column = "ENTREZID", keytype = "SYMBOL")
PBMC_markerGene_ids <- mapIds(org.Hs.eg.db, keys = PBMC_markerGenes, column = "ENTREZID", keytype = "SYMBOL")

```

# pathway enrichment analysis
```{r}
# 
pa1 <- enrichPathway(gene = tumor_markerGene_ids, organism = "human", pvalueCutoff = 0.05)
pa2 <- enrichPathway(gene = PBMC_markerGene_ids, organism = "human", pvalueCutoff = 0.05)
# Create a dataframe to store the results of the enrichment analysis
df <- data.frame(
  pathway = c(pa1@result$Description, pa2@result$Description),
  enrichment = c(pa1@result$pvalue, pa2@result$pvalue),
  group = c(rep("Tumor",length(pa1@result$Description)), rep("PBMC",length(pa2@result$Description)))
)

# Arrange the plots side by side
pdf(file = paste0(PENCIL_result_dir_deep, "Barplot_pathway_enrichment.pdf"), width = 14, height = 10*0.5) 
p1 <- barplot(pa1, showCategory = 10,p.adjust.digits = 1)
p2 <- barplot(pa2, showCategory = 10,p.adjust.digits = 1)
grid.arrange(p1, p2, ncol = 2) + theme(axis.text.y = element_text(size = 12))
dev.off()

```


# Calculate known ICB signature UCell score and ICG score
```{r}

ICB_sig <- list(
    Exhaustion = c('PDCD1', 'CTLA4', 'LAG3', 'HAVCR2', 'TIGIT'), 
    IFNG = c('IDO1', 'CXCL10', 'CXCL9', 'HLA-DRA', 'IFNG', 'STAT1'), 
    TRM = c("IL17A", "IL10", "IL2", "IFNG", "DUSP6", "PDCD1", "CRTAM", "ITGA1", "ITGAE", "CD69", "CD101", "CXCR6", "SELL-", "S1PR1-", "S1PR5-", "CX3CR1-", "MKI67-", "KLF2-", "KLF3-") 
)

if('Exhaustion' %in% colnames(merged_seu@meta.data)) {
  1
} else {
  merged_seu <- AddModuleScore_UCell(merged_seu, features=ICB_sig, name=NULL)
}

saveRDS(object = merged_seu, file = paste0(processed_dir_train,"seu_all_CD8T_PENCIL.rds")) 

```

# Violin plot of know signature scores for N/NR cells
```{r}

merged_seu_subset = subset(merged_seu, subset = PENCIL_pred_label_tissue!='rej')
p <- VlnPlot(merged_seu_subset, group.by = "PENCIL_pred_label_tissue", features = "Exhaustion", pt.size = 0, ncol = 1) +
  NoLegend()+
  xlab("")+
  ylab("")+
  ylim(0,1)
p <- p + 
  theme(axis.text.x = element_blank(),
       axis.ticks.x = element_blank(),
       legend.position = "none",
       plot.title = element_blank(),
       axis.title.x = element_blank(),
       axis.title.y = element_blank())
ggsave(plot = p,path = PENCIL_result_dir_deep,  filename = paste0("Vln_ICBsig_Exhaustion.pdf"),  width = 2, height = 2.5)

# Perform the Wilcoxon rank sum test
result <- wilcox.test(merged_seu_subset$Exhaustion[merged_seu_subset$PENCIL_pred_label_tissue=='yes'], merged_seu_subset$Exhaustion[merged_seu_subset$PENCIL_pred_label_tissue=='no'])
p_value <- result$p.value
cat("Wilcoxon Rank Sum Test p-value:", p_value, "\n")




p <- VlnPlot(merged_seu_subset, group.by = "PENCIL_pred_label_tissue", features = "IFNG", pt.size = 0, ncol = 1) +
  NoLegend()+
  xlab("")+
  ylab("")+
  ylim(0,1)
p <- p + 
  theme(axis.text.x = element_blank(),
       axis.ticks.x = element_blank(),
       legend.position = "none",
       plot.title = element_blank(),
       axis.title.x = element_blank(),
       axis.title.y = element_blank())
ggsave(plot = p,path = PENCIL_result_dir_deep,  filename = paste0("Vln_ICBsig_IFNG.pdf"),  width = 2, height = 2.5)

# Perform the Wilcoxon rank sum test
result <- wilcox.test(merged_seu_subset$IFNG[merged_seu_subset$PENCIL_pred_label_tissue=='yes'], merged_seu_subset$IFNG[merged_seu_subset$PENCIL_pred_label_tissue=='no'])
p_value <- result$p.value
cat("Wilcoxon Rank Sum Test p-value:", p_value, "\n")




p <- VlnPlot(merged_seu_subset, group.by = "PENCIL_pred_label_tissue", features = "TRM", pt.size = 0, ncol = 1) +
  NoLegend()+
  xlab("")+
  ylab("")+
  ylim(0,1)
p <- p + 
  theme(axis.text.x = element_blank(),
       axis.ticks.x = element_blank(),
       legend.position = "none",
       plot.title = element_blank(),
       axis.title.x = element_blank(),
       axis.title.y = element_blank())
ggsave(plot = p,path = PENCIL_result_dir_deep,  filename = paste0("Vln_ICBsig_TRM.pdf"),  width = 2, height = 2.5)

# Perform the Wilcoxon rank sum test
result <- wilcox.test(merged_seu_subset$TRM[merged_seu_subset$PENCIL_pred_label_tissue=='yes'], merged_seu_subset$TRM[merged_seu_subset$PENCIL_pred_label_tissue=='no'])
p_value <- result$p.value
cat("Wilcoxon Rank Sum Test p-value:", p_value, "\n")

```


```{r}

#merged_seu_subset = subset(merged_seu, subset = PENCIL_pred_label_tissue!='rej')

p <- VlnPlot(merged_seu_subset, group.by = "PENCIL_pred_label_tissue", features = "HLA-DRB1", pt.size = 0, ncol = 1) +
  NoLegend()+
  xlab("")+
  ylab("")+
  ylim(-0.1,5)
p <- p + 
  theme(axis.text.x = element_blank(),
       axis.ticks.x = element_blank(),
       legend.position = "none",
       plot.title = element_blank(),
       axis.title.x = element_blank(),
       axis.title.y = element_blank())
ggsave(plot = p,path = PENCIL_result_dir_deep,  filename = paste0("Vln_ICBsig_HLA-DRB1.pdf"),  width = 2, height = 2.5)

# Perform the Wilcoxon rank sum test
result <- wilcox.test(merged_seu_subset@assays[['RNA']]@data["HLA-DRB1",merged_seu_subset$PENCIL_pred_label_tissue=='yes'], merged_seu_subset@assays[['RNA']]@data["HLA-DRB1",merged_seu_subset$PENCIL_pred_label_tissue=='no'])
p_value <- result$p.value
cat("logFC:", mean(merged_seu_subset@assays[['RNA']]@data["HLA-DRB1",merged_seu_subset$PENCIL_pred_label_tissue=='yes']) - mean(merged_seu_subset@assays[['RNA']]@data["HLA-DRB1",merged_seu_subset$PENCIL_pred_label_tissue=='no']), "\n")
cat("Wilcoxon Rank Sum Test p-value:", p_value, "\n")



p <- VlnPlot(merged_seu_subset, group.by = "PENCIL_pred_label_tissue", features = "LAG3", pt.size = 0, ncol = 1) +
  NoLegend()+
  xlab("")+
  ylab("")+
  ylim(-0.1,5)
p <- p + 
  theme(axis.text.x = element_blank(),
       axis.ticks.x = element_blank(),
       legend.position = "none",
       plot.title = element_blank(),
       axis.title.x = element_blank(),
       axis.title.y = element_blank())
ggsave(plot = p,path = PENCIL_result_dir_deep,  filename = paste0("Vln_ICBsig_LAG3.pdf"),  width = 2, height = 2.5)

# Perform the Wilcoxon rank sum test
result <- wilcox.test(merged_seu_subset@assays[['RNA']]@data["LAG3",merged_seu_subset$PENCIL_pred_label_tissue=='yes'], merged_seu_subset@assays[['RNA']]@data["LAG3",merged_seu_subset$PENCIL_pred_label_tissue=='no'])
p_value <- result$p.value
cat("logFC:", mean(merged_seu_subset@assays[['RNA']]@data["LAG3",merged_seu_subset$PENCIL_pred_label_tissue=='yes']) - mean(merged_seu_subset@assays[['RNA']]@data["LAG3",merged_seu_subset$PENCIL_pred_label_tissue=='no']), "\n")
cat("Wilcoxon Rank Sum Test p-value:", p_value, "\n")



p <- VlnPlot(merged_seu_subset, group.by = "PENCIL_pred_label_tissue", features = "TIGIT", pt.size = 0, ncol = 1) +
  NoLegend()+
  xlab("")+
  ylab("")+
  ylim(-0.1,5)
p <- p + 
  theme(axis.text.x = element_blank(),
       axis.ticks.x = element_blank(),
       legend.position = "none",
       plot.title = element_blank(),
       axis.title.x = element_blank(),
       axis.title.y = element_blank())
ggsave(plot = p,path = PENCIL_result_dir_deep,  filename = paste0("Vln_ICBsig_TIGIT.pdf"),  width = 2, height = 2.5)

# Perform the Wilcoxon rank sum test
result <- wilcox.test(merged_seu_subset@assays[['RNA']]@data["TIGIT",merged_seu_subset$PENCIL_pred_label_tissue=='yes'], merged_seu_subset@assays[['RNA']]@data["TIGIT",merged_seu_subset$PENCIL_pred_label_tissue=='no'])
p_value <- result$p.value
cat("logFC:", mean(merged_seu_subset@assays[['RNA']]@data["TIGIT",merged_seu_subset$PENCIL_pred_label_tissue=='yes']) - mean(merged_seu_subset@assays[['RNA']]@data["TIGIT",merged_seu_subset$PENCIL_pred_label_tissue=='no']), "\n")
cat("Wilcoxon Rank Sum Test p-value:", p_value, "\n")



```

