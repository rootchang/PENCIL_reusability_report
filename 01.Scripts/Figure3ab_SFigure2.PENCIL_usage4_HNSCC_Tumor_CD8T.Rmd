---
title: "Predict cell origin in HNSCC using PENCIL predicted tumor-relevant CD8+T cells"
author: "Tiangen Chang tiangen.chang@nih.gov"
output: 
  rmarkdown::html_vignette:
    toc: true
    toc_depth: 2
vignette: >
  %\VignetteIndexEntry{}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


# load required package
```{r, include=FALSE}
#if (!require("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
#BiocManager::install("UCell")
library(UCell)

#devtools::install_github("mojaveazure/seurat-disk")
#devtools::install_github('satijalab/seurat-data')
library(SeuratData)
library(SeuratDisk)

library(caret)
library(Seurat)
library(GEOquery)
library(dplyr)
library(ggplot2)
library(SingleR)
library(sctransform)
library(celldex)
library(dittoSeq)
library(SeuratWrappers)
library(harmony)
library(scuttle)
library(scran)
library(scFeatureFilter)
library(cowplot)
library(patchwork)
library(edgeR)
library(RColorBrewer)
library(stringr)

```


# set input and output directories & parameters
```{r}

shared_data_dir = paste0("../02.Input/")
PENCIL_result_dir = paste0("./01.Scripts/results/")

dataset_train = 'GSE139324'
processed_dir_train <- paste0("../03.Results/", dataset_train, '/')
fig_dir_train = paste0("../03.Results/", dataset_train, "/Figures/")

dataset_test1 = 'GSE164690'
processed_dir_test1 <- paste0("../03.Results/", dataset_test1, '/')
fig_dir_test1 = paste0("../03.Results/", dataset_test1, "/Figures/")

dataset_test2 = 'GSE162025'
processed_dir_test2 <- paste0("../03.Results/", dataset_test2, '/')
fig_dir_test2 = paste0("../03.Results/", dataset_test2, "/Figures/")

dataset_test3 = 'GSE200996'
processed_dir_test3 <- paste0("../03.Results/", dataset_test3, '/')
fig_dir_test3 = paste0("../03.Results/", dataset_test3, "/Figures/")

dataset_test4 = 'GSE180268'
processed_dir_test4 <- paste0("../03.Results/", dataset_test4, '/')
fig_dir_test4 = paste0("../03.Results/", dataset_test4, "/Figures/")

dataset_test5 = 'GSE182227'
processed_dir_test5 <- paste0("../03.Results/", dataset_test5, '/')
fig_dir_test5 = paste0("../03.Results/", dataset_test5, "/Figures/")

```

# make PENCIL input files for training data (tumor CD8T cells) (Figure 3a)
```{r}

sampleType_name = 'all'
phenotype_name = 'tissue'
cellType_of_interest = 'CD8T'

merged_seu_subset = readRDS(file = paste0(processed_dir_train,"seu_",sampleType_name,"_",cellType_of_interest,".rds"))
merged_seu_subset$tissue <- ifelse(merged_seu_subset$tissue == "TIL", 1, 0)

#### print cell number for each phenotype, used for class_weights setting
print(table(merged_seu_subset$tissue))

# filter genes to keep only protein coding genes
protein_coding_gene_file = paste0(shared_data_dir, 'Feldman_protein_coding_genes.csv')
protein_coding_genes=read.csv(protein_coding_gene_file, header=T)[,1]
genes <- intersect(protein_coding_genes, row.names(merged_seu_subset))
merged_seu_subset <- merged_seu_subset[genes, ]

merged_seu_subset <- FindVariableFeatures(object=merged_seu_subset, selection.method='vst', nfeatures=2000)
### default gene order by variance (high to low)
variable_genes <- VariableFeatures(merged_seu_subset)
merged_seu_subset <- ScaleData(merged_seu_subset)
merged_seu_subset <- RunPCA(object=merged_seu_subset, features=variable_genes)
merged_seu_subset <- FindNeighbors(object=merged_seu_subset, dims=1:10, k.param=20)
merged_seu_subset <- FindClusters(object=merged_seu_subset, resolution=1.6)
merged_seu_subset <- RunUMAP(object=merged_seu_subset, dims=1:10)


# Plot UMAP of PBMC/TIL
merged_seu_subset$tissue = factor(merged_seu_subset$tissue, level=c(0,1))
DimPlot(merged_seu_subset, group.by = "tissue", pt.size = 0.1)+NoLegend() +
  scale_color_manual(values = c("forestgreen", "firebrick"))+
  ggtitle("")
ggsave(filename = paste0(fig_dir_train, "UMAP_tissue_",sampleType_name, '_', cellType_of_interest, '_', phenotype_name,".pdf"),height = 60*1.2, width = 60*1.2, units = "mm")


exp_data_scaled = merged_seu_subset@assays[["RNA"]]@scale.data[variable_genes,]
write.csv(exp_data_scaled, file=paste0(processed_dir_train,"seu_",sampleType_name,'_',cellType_of_interest,'_',phenotype_name,".csv"))
cell_label_df = data.frame(label = merged_seu_subset@meta.data[phenotype_name])
write.csv(cell_label_df, file=paste0(processed_dir_train,"seu_",sampleType_name,'_',cellType_of_interest,'_',phenotype_name,"cell_label_info.csv"))
emd = merged_seu_subset@reductions[["umap"]]@cell.embeddings
write.csv(emd, file=paste0(processed_dir_train, "seu_",sampleType_name,'_',cellType_of_interest,'_',phenotype_name,'_embedding_umap.csv'))

saveRDS(object = merged_seu_subset, file = paste0(processed_dir_train, "seu_",sampleType_name,"_", cellType_of_interest, "_PENCIL.rds")) 

```

## make PENCIL input files for test1 (Fill 0-value for missing genes in new test data)
```{r}

sampleType_name = 'all3samples'
phenotype_name = 'tissue'
cellType_of_interest = 'CD8T'

merged_seu_subset = readRDS(file = paste0(processed_dir_test1,"seu_",sampleType_name,"_",cellType_of_interest,".rds"))
merged_seu_subset$tissue <- ifelse(merged_seu_subset$sample == "Tissue", 1, 0)

num_fill_genes = length(variable_genes) - sum(variable_genes %in% row.names(merged_seu_subset))
print(num_fill_genes)
if (num_fill_genes > 0){
  num_cells = dim(merged_seu_subset)[2]
  fill_data <- rep(0, num_fill_genes * num_cells)
  dim(fill_data) <- c(num_fill_genes, num_cells)
  row.names(fill_data) <- setdiff(variable_genes, row.names(merged_seu_subset))
  colnames(fill_data) <- colnames(merged_seu_subset)
  counts <- as.matrix(merged_seu_subset@assays[["RNA"]]@counts)
  counts <- rbind(counts, fill_data)
  merged_seu_subset.filled <- CreateSeuratObject(counts=counts, meta.data=merged_seu_subset@meta.data)
  merged_seu_subset = merged_seu_subset.filled
}
VariableFeatures(merged_seu_subset) <- variable_genes
merged_seu_subset <- NormalizeData(object=merged_seu_subset, normalization.method="LogNormalize")
merged_seu_subset <- ScaleData(object=merged_seu_subset)
merged_seu_subset <- RunPCA(object=merged_seu_subset, features=variable_genes)
merged_seu_subset <- FindNeighbors(object=merged_seu_subset, dims=1:10, k.param=20)
merged_seu_subset <- FindClusters(object=merged_seu_subset, resolution=1.6)
merged_seu_subset <- RunUMAP(object=merged_seu_subset, dims=1:10)


# Plot UMAP of PBMC/TIL to check batch effect
DimPlot(merged_seu_subset, group.by = "tissue", raster=FALSE)+
  ggtitle("")
ggsave(filename = paste0(fig_dir_test1, "UMAP_tissue_",sampleType_name,".png"), height = 120, width = 190, dpi = 800, units = "mm")


exp_data_scaled = merged_seu_subset@assays[["RNA"]]@scale.data[variable_genes,]
write.csv(exp_data_scaled, file=paste0(processed_dir_test1,"seu_",sampleType_name,'_',cellType_of_interest,'_',phenotype_name,".csv"))
cell_label_df = data.frame(label = merged_seu_subset@meta.data[phenotype_name])
write.csv(cell_label_df, file=paste0(processed_dir_test1,"cell_label_info.csv"))
emd = merged_seu_subset@reductions[["umap"]]@cell.embeddings
write.csv(emd, file=paste0(processed_dir_test1, "seu_",sampleType_name,'_',cellType_of_interest,'_embedding_umap.csv'))

saveRDS(object = merged_seu_subset, file = paste0(processed_dir_test1, "seu_",sampleType_name,"_", cellType_of_interest, "_PENCIL.rds")) 

```

## make PENCIL input files for test2 (Fill 0-value for missing genes in new test data)
```{r}

sampleType_name = 'all'
phenotype_name = 'tissue'
cellType_of_interest = 'CD8T'

merged_seu_subset = readRDS(file = paste0(processed_dir_test2,"seu_",sampleType_name,"_",cellType_of_interest,".rds"))
merged_seu_subset$tissue <- ifelse(merged_seu_subset$tissue == "Tumor", 1, 0)

num_fill_genes = length(variable_genes) - sum(variable_genes %in% row.names(merged_seu_subset))
print(num_fill_genes)
if (num_fill_genes > 0){
  num_cells = dim(merged_seu_subset)[2]
  fill_data <- rep(0, num_fill_genes * num_cells)
  dim(fill_data) <- c(num_fill_genes, num_cells)
  row.names(fill_data) <- setdiff(variable_genes, row.names(merged_seu_subset))
  colnames(fill_data) <- colnames(merged_seu_subset)
  counts <- as.matrix(merged_seu_subset@assays[["RNA"]]@counts)
  counts <- rbind(counts, fill_data)
  merged_seu_subset.filled <- CreateSeuratObject(counts=counts, meta.data=merged_seu_subset@meta.data)
  merged_seu_subset = merged_seu_subset.filled
}
VariableFeatures(merged_seu_subset) <- variable_genes
merged_seu_subset <- NormalizeData(object=merged_seu_subset, normalization.method="LogNormalize")
merged_seu_subset <- ScaleData(object=merged_seu_subset)
merged_seu_subset <- RunPCA(object=merged_seu_subset, features=variable_genes)
merged_seu_subset <- FindNeighbors(object=merged_seu_subset, dims=1:10, k.param=20)
merged_seu_subset <- FindClusters(object=merged_seu_subset, resolution=1.6)
merged_seu_subset <- RunUMAP(object=merged_seu_subset, dims=1:10)


# Plot UMAP of PBMC/TIL to check batch effect
DimPlot(merged_seu_subset, group.by = "tissue", raster=FALSE)+
  ggtitle("")
ggsave(filename = paste0(fig_dir_test2, "UMAP_tissue_",sampleType_name,".png"), height = 120, width = 190, dpi = 800, units = "mm")


exp_data_scaled = merged_seu_subset@assays[["RNA"]]@scale.data[variable_genes,]
write.csv(exp_data_scaled, file=paste0(processed_dir_test2,"seu_",sampleType_name,'_',cellType_of_interest,'_',phenotype_name,".csv"))
cell_label_df = data.frame(label = merged_seu_subset@meta.data[phenotype_name])
write.csv(cell_label_df, file=paste0(processed_dir_test2,"cell_label_info.csv"))
emd = merged_seu_subset@reductions[["umap"]]@cell.embeddings
write.csv(emd, file=paste0(processed_dir_test2, "seu_",sampleType_name,'_',cellType_of_interest,'_embedding_umap.csv'))

saveRDS(object = merged_seu_subset, file = paste0(processed_dir_test2, "seu_",sampleType_name,"_", cellType_of_interest, "_PENCIL.rds")) 

```


## make PENCIL input files for test3 (Fill 0-value for missing genes in new test data)
```{r}

sampleType_name = 'all'
phenotype_name = 'tissue'
cellType_of_interest = 'CD8T'

merged_seu_subset = readRDS(file = paste0(processed_dir_test3,"seu_",sampleType_name,"_",cellType_of_interest,".rds"))
merged_seu_subset$tissue <- gsub("^.*[-_]", "", merged_seu_subset$meta)
merged_seu_subset$tissue[merged_seu_subset$tissue=='B1'] = 0
merged_seu_subset$tissue[merged_seu_subset$tissue=='B2'] = 0
merged_seu_subset$tissue[merged_seu_subset$tissue=='B3'] = 0
merged_seu_subset$tissue[merged_seu_subset$tissue=='tumor'] = 1


num_fill_genes = length(variable_genes) - sum(variable_genes %in% row.names(merged_seu_subset))
print(num_fill_genes)
if (num_fill_genes > 0){
  num_cells = dim(merged_seu_subset)[2]
  fill_data <- rep(0, num_fill_genes * num_cells)
  dim(fill_data) <- c(num_fill_genes, num_cells)
  row.names(fill_data) <- setdiff(variable_genes, row.names(merged_seu_subset))
  colnames(fill_data) <- colnames(merged_seu_subset)
  counts <- as.matrix(merged_seu_subset@assays[["RNA"]]@counts)
  counts <- rbind(counts, fill_data)
  merged_seu_subset.filled <- CreateSeuratObject(counts=counts, meta.data=merged_seu_subset@meta.data)
  merged_seu_subset = merged_seu_subset.filled
}
VariableFeatures(merged_seu_subset) <- variable_genes
merged_seu_subset <- NormalizeData(object=merged_seu_subset, normalization.method="LogNormalize")
merged_seu_subset <- ScaleData(object=merged_seu_subset)
merged_seu_subset <- RunPCA(object=merged_seu_subset, features=variable_genes)
merged_seu_subset <- FindNeighbors(object=merged_seu_subset, dims=1:10, k.param=20)
merged_seu_subset <- FindClusters(object=merged_seu_subset, resolution=1.6)
merged_seu_subset <- RunUMAP(object=merged_seu_subset, dims=1:10)


# Plot UMAP of PBMC/TIL to check batch effect
DimPlot(merged_seu_subset, group.by = "tissue", raster=FALSE)+
  ggtitle("")
ggsave(filename = paste0(fig_dir_test3, "UMAP_tissue_",sampleType_name,".png"), height = 120, width = 190, dpi = 800, units = "mm")


exp_data_scaled = merged_seu_subset@assays[["RNA"]]@scale.data[variable_genes,]
write.csv(exp_data_scaled, file=paste0(processed_dir_test3,"seu_",sampleType_name,'_',cellType_of_interest,'_',phenotype_name,".csv"))
cell_label_df = data.frame(label = merged_seu_subset@meta.data[phenotype_name])
write.csv(cell_label_df, file=paste0(processed_dir_test3,"cell_label_info.csv"))
emd = merged_seu_subset@reductions[["umap"]]@cell.embeddings
write.csv(emd, file=paste0(processed_dir_test3, "seu_",sampleType_name,'_',cellType_of_interest,'_embedding_umap.csv'))

saveRDS(object = merged_seu_subset, file = paste0(processed_dir_test3, "seu_",sampleType_name,"_", cellType_of_interest, "_PENCIL.rds")) 

```



## make PENCIL input files for test4 (Fill 0-value for missing genes in new test data)
```{r}

sampleType_name = 'Tumor'
phenotype_name = 'tissue'
cellType_of_interest = 'CD8T'

merged_seu_subset = readRDS(file = paste0(processed_dir_test4,"seu_",sampleType_name,"_",cellType_of_interest,".rds"))
merged_seu_subset$tissue = 1 # all PBMC samples

num_fill_genes = length(variable_genes) - sum(variable_genes %in% row.names(merged_seu_subset))
print(num_fill_genes)
if (num_fill_genes > 0){
  num_cells = dim(merged_seu_subset)[2]
  fill_data <- rep(0, num_fill_genes * num_cells)
  dim(fill_data) <- c(num_fill_genes, num_cells)
  row.names(fill_data) <- setdiff(variable_genes, row.names(merged_seu_subset))
  colnames(fill_data) <- colnames(merged_seu_subset)
  counts <- as.matrix(merged_seu_subset@assays[["RNA"]]@counts)
  counts <- rbind(counts, fill_data)
  merged_seu_subset.filled <- CreateSeuratObject(counts=counts, meta.data=merged_seu_subset@meta.data)
  merged_seu_subset = merged_seu_subset.filled
}
VariableFeatures(merged_seu_subset) <- variable_genes
merged_seu_subset <- NormalizeData(object=merged_seu_subset, normalization.method="LogNormalize")
merged_seu_subset <- ScaleData(object=merged_seu_subset)
merged_seu_subset <- RunPCA(object=merged_seu_subset, features=variable_genes)
merged_seu_subset <- FindNeighbors(object=merged_seu_subset, dims=1:10, k.param=20)
merged_seu_subset <- FindClusters(object=merged_seu_subset, resolution=1.6)
merged_seu_subset <- RunUMAP(object=merged_seu_subset, dims=1:10)

exp_data_scaled = merged_seu_subset@assays[["RNA"]]@scale.data[variable_genes,]
write.csv(exp_data_scaled, file=paste0(processed_dir_test4,"seu_",sampleType_name,'_',cellType_of_interest,'_',phenotype_name,".csv"))

saveRDS(object = merged_seu_subset, file = paste0(processed_dir_test4, "seu_",sampleType_name,"_", cellType_of_interest,'_',phenotype_name, "_PENCIL.rds")) 

```


## make PENCIL input files for test5 (Fill 0-value for missing genes in new test data)
```{r}

sampleType_name = 'Tissue'
phenotype_name = 'tissue'
cellType_of_interest = 'CD8T'

merged_seu_subset = readRDS(file = paste0(processed_dir_test5,"seu_",sampleType_name,"_",cellType_of_interest,".rds"))
merged_seu_subset$tissue = 1 # all tumor tissue samples

num_fill_genes = length(variable_genes) - sum(variable_genes %in% row.names(merged_seu_subset))
print(num_fill_genes)
if (num_fill_genes > 0){
  num_cells = dim(merged_seu_subset)[2]
  fill_data <- rep(0, num_fill_genes * num_cells)
  dim(fill_data) <- c(num_fill_genes, num_cells)
  row.names(fill_data) <- setdiff(variable_genes, row.names(merged_seu_subset))
  colnames(fill_data) <- colnames(merged_seu_subset)
  counts <- as.matrix(merged_seu_subset@assays[["RNA"]]@counts)
  counts <- rbind(counts, fill_data)
  merged_seu_subset.filled <- CreateSeuratObject(counts=counts, meta.data=merged_seu_subset@meta.data)
  merged_seu_subset = merged_seu_subset.filled
}
VariableFeatures(merged_seu_subset) <- variable_genes
merged_seu_subset <- NormalizeData(object=merged_seu_subset, normalization.method="LogNormalize")
merged_seu_subset <- ScaleData(object=merged_seu_subset)
merged_seu_subset <- RunPCA(object=merged_seu_subset, features=variable_genes)
merged_seu_subset <- FindNeighbors(object=merged_seu_subset, dims=1:10, k.param=20)
merged_seu_subset <- FindClusters(object=merged_seu_subset, resolution=1.6)
merged_seu_subset <- RunUMAP(object=merged_seu_subset, dims=1:10)

exp_data_scaled = merged_seu_subset@assays[["RNA"]]@scale.data[variable_genes,]
write.csv(exp_data_scaled, file=paste0(processed_dir_test5,"seu_",sampleType_name,'_',cellType_of_interest,'_',phenotype_name,".csv"))

saveRDS(object = merged_seu_subset, file = paste0(processed_dir_test5, "seu_",sampleType_name,"_", cellType_of_interest,'_',phenotype_name, "_PENCIL.rds")) 

```

# Run PENCIL
```{bash}

## one may use gpu to accelerate running PENCIL, otherwise it would be very slow
sinteractive --mem=128g --cpus-per-task=32 --gres=gpu:k80:2 --time=24:00:00
## PENCIL has been installed in python/3.8
module load python/3.8

## Run PENCIL
python Run_PENCIL_csv.py ../03.Results/GSE139324/seu_all_CD8T_tissue.csv ../03.Results/GSE139324/seu_all_CD8T_tissuecell_label_info.csv ../03.Results/GSE139324/seu_all_CD8T_tissue_embedding_umap.csv GSE139324_all_CD8T Tumor multi-classification 2,1 ../03.Results/GSE164690/seu_all3samples_CD8T_tissue.csv,../03.Results/GSE162025/seu_all_CD8T_tissue.csv,../03.Results/GSE200996/seu_all_CD8T_tissue.csv,../03.Results/GSE180268/seu_Tumor_CD8T_tissue.csv,../03.Results/GSE182227/seu_Tissue_CD8T_tissue.csv

```


# Add PENCIL identified phenotypic cell labels to all training and test datasets
```{r}

PENCIL_result_dir_deep = paste0(PENCIL_result_dir, 'GSE139324_all_CD8T/py/Tumor/')

#### for training data
# load seurat object
merged_seu_subset = readRDS(file = paste0(processed_dir_train,"seu_all_CD8T_PENCIL.rds"))

predicted_cell_labels = read.csv(paste0(PENCIL_result_dir_deep, 'predicted_labels.csv'))
predicted_cell_labels_new <- subset(predicted_cell_labels, select = 'predicted_label')
colnames(predicted_cell_labels_new) = c(paste0("PENCIL_pred_label_",phenotype_name))

# change label names to yes, no, rej
label_names = unique(predicted_cell_labels_new[paste0("PENCIL_pred_label_",phenotype_name)])
print(label_names)
predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]] <- gsub("1", "yes", predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])
predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]] <- gsub("0", "no", predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])
predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]] <- gsub("Rejected", "rej", predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])

meta <- merged_seu_subset@meta.data
meta.new <- cbind(meta, predicted_cell_labels_new) # cell ID in PENCIL output does not match the original ones. But it is in the same order.
merged_seu_subset <- AddMetaData(merged_seu_subset, meta.new)
merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_",phenotype_name)]] <- factor(merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_",phenotype_name)]], levels = c("yes", "no", "rej"))
print(table(merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_",phenotype_name)]]))

saveRDS(object = merged_seu_subset, file = paste0(processed_dir_train,"seu_all_CD8T_PENCIL.rds")) 


#### for test1 data
# load seurat object
merged_seu_subset = readRDS(file = paste0(processed_dir_test1,"seu_all3samples_CD8T_PENCIL.rds"))

predicted_cell_labels = read.csv(paste0(PENCIL_result_dir_deep, 'predicted_labels_test1.csv'))
predicted_cell_labels_new <- subset(predicted_cell_labels, select = 'predicted_label')
colnames(predicted_cell_labels_new) = c(paste0("PENCIL_pred_label_",phenotype_name))

# change label names to yes, no, rej
label_names = unique(predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])
print(label_names)
predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]] <- gsub("1", "yes", predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])
predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]] <- gsub("0", "no", predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])
predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]] <- gsub("Rejected", "rej", predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])

meta <- merged_seu_subset@meta.data
meta.new <- cbind(meta, predicted_cell_labels_new) # cell ID in PENCIL output does not match the original ones. But it is in the same order.
merged_seu_subset <- AddMetaData(merged_seu_subset, meta.new)
merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_",phenotype_name)]] <- factor(merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_",phenotype_name)]], levels = c("yes", "no", "rej"))
print(table(merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_",phenotype_name)]]))

saveRDS(object = merged_seu_subset, file = paste0(processed_dir_test1,"seu_all3samples_CD8T_PENCIL.rds")) 


#### for test2 data
# load seurat object
merged_seu_subset = readRDS(file = paste0(processed_dir_test2,"seu_all_CD8T_PENCIL.rds"))

predicted_cell_labels = read.csv(paste0(PENCIL_result_dir_deep, 'predicted_labels_test2.csv'))
predicted_cell_labels_new <- subset(predicted_cell_labels, select = 'predicted_label')
colnames(predicted_cell_labels_new) = c(paste0("PENCIL_pred_label_",phenotype_name))

# change label names to yes, no, rej
label_names = unique(predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])
print(label_names)
predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]] <- gsub("1", "yes", predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])
predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]] <- gsub("0", "no", predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])
predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]] <- gsub("Rejected", "rej", predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])

meta <- merged_seu_subset@meta.data
meta.new <- cbind(meta, predicted_cell_labels_new) # cell ID in PENCIL output does not match the original ones. But it is in the same order.
merged_seu_subset <- AddMetaData(merged_seu_subset, meta.new)
merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_",phenotype_name)]] <- factor(merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_",phenotype_name)]], levels = c("yes", "no", "rej"))
print(table(merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_",phenotype_name)]]))

saveRDS(object = merged_seu_subset, file = paste0(processed_dir_test2,"seu_all_CD8T_PENCIL.rds")) 


#### for test3 data
# load seurat object
merged_seu_subset = readRDS(file = paste0(processed_dir_test3,"seu_all_CD8T_PENCIL.rds"))

predicted_cell_labels = read.csv(paste0(PENCIL_result_dir_deep, 'predicted_labels_test3.csv'))
predicted_cell_labels_new <- subset(predicted_cell_labels, select = 'predicted_label')
colnames(predicted_cell_labels_new) = c(paste0("PENCIL_pred_label_",phenotype_name))

# change label names to yes, no, rej
label_names = unique(predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])
print(label_names)
predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]] <- gsub("1", "yes", predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])
predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]] <- gsub("0", "no", predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])
predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]] <- gsub("Rejected", "rej", predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])

meta <- merged_seu_subset@meta.data
meta.new <- cbind(meta, predicted_cell_labels_new) # cell ID in PENCIL output does not match the original ones. But it is in the same order.
merged_seu_subset <- AddMetaData(merged_seu_subset, meta.new)
merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_",phenotype_name)]] <- factor(merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_",phenotype_name)]], levels = c("yes", "no", "rej"))
print(table(merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_",phenotype_name)]]))

saveRDS(object = merged_seu_subset, file = paste0(processed_dir_test3,"seu_all_CD8T_PENCIL.rds")) 


#### for test4 data
# load seurat object
merged_seu_subset = readRDS(file = paste0(processed_dir_test4,"seu_Tumor_CD8T_tissue_PENCIL.rds"))
merged_seu_subset$tissue = 1
predicted_cell_labels = read.csv(paste0(PENCIL_result_dir_deep, 'predicted_labels_test4.csv'))
predicted_cell_labels_new <- subset(predicted_cell_labels, select = 'predicted_label')
colnames(predicted_cell_labels_new) = c(paste0("PENCIL_pred_label_",phenotype_name))

# change label names to yes, no, rej
label_names = unique(predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])
print(label_names)
predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]] <- gsub("1", "yes", predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])
predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]] <- gsub("0", "no", predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])
predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]] <- gsub("Rejected", "rej", predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])

meta <- merged_seu_subset@meta.data
meta.new <- cbind(meta, predicted_cell_labels_new) # cell ID in PENCIL output does not match the original ones. But it is in the same order.
merged_seu_subset <- AddMetaData(merged_seu_subset, meta.new)
merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_",phenotype_name)]] <- factor(merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_",phenotype_name)]], levels = c("yes", "no", "rej"))
print(table(merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_",phenotype_name)]]))

saveRDS(object = merged_seu_subset, file = paste0(processed_dir_test4,"seu_Tumor_CD8T_tissue_PENCIL.rds")) 


#### for test5 data
# load seurat object
merged_seu_subset = readRDS(file = paste0(processed_dir_test5,"seu_Tissue_CD8T_tissue_PENCIL.rds"))

predicted_cell_labels = read.csv(paste0(PENCIL_result_dir_deep, 'predicted_labels_test5.csv'))
predicted_cell_labels_new <- subset(predicted_cell_labels, select = 'predicted_label')
colnames(predicted_cell_labels_new) = c(paste0("PENCIL_pred_label_",phenotype_name))

# change label names to yes, no, rej
label_names = unique(predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])
print(label_names)
predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]] <- gsub("1", "yes", predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])
predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]] <- gsub("0", "no", predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])
predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]] <- gsub("Rejected", "rej", predicted_cell_labels_new[[paste0("PENCIL_pred_label_",phenotype_name)]])

meta <- merged_seu_subset@meta.data
meta.new <- cbind(meta, predicted_cell_labels_new) # cell ID in PENCIL output does not match the original ones. But it is in the same order.
merged_seu_subset <- AddMetaData(merged_seu_subset, meta.new)
merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_",phenotype_name)]] <- factor(merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_",phenotype_name)]], levels = c("yes", "no", "rej"))
print(table(merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_",phenotype_name)]]))

saveRDS(object = merged_seu_subset, file = paste0(processed_dir_test5,"seu_Tissue_CD8T_tissue_PENCIL.rds")) 
```


# Calculate R/NR cell number and ratios in each patient for all training and test datasets (Figure 3b; Supplementary Figure 2)
```{r}

min_cellNum_per_patient = 50

#### for training data
# load seurat object
merged_seu_subset = readRDS(file = paste0(processed_dir_train,"seu_all_CD8T_PENCIL.rds"))
merged_seu_subset$meta = merged_seu_subset$sample
patient_CD8Tcell_num = sort(table(merged_seu_subset$meta))
keep_patient = names(patient_CD8Tcell_num)[patient_CD8Tcell_num > min_cellNum_per_patient]
merged_seu_subset = subset(merged_seu_subset, subset = meta %in% keep_patient)
sampleNUM = length(unique(merged_seu_subset$meta))
print(paste('Total samples: ', sampleNUM))

# Calculate the cell number for each patient
grouped <- merged_seu_subset@meta.data %>% group_by(meta, !!sym(paste0("PENCIL_pred_label_", phenotype_name)))
# Calculate the number of cells for each patient and predicted_label
cell_counts <- grouped %>% summarise(cell_count = n())
cell_counts <- cell_counts[cell_counts[[paste0("PENCIL_pred_label_", phenotype_name)]] != "rej", ]
# Create a vector with all unique patient IDs
all_patients <- unique(cell_counts$meta)
print(unique(merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_", phenotype_name)]]))

unique_label = c("yes","no")
# Create a new data frame with all patients having both 'yes' and 'no'
new_df <- data.frame(meta = rep(all_patients, each = 2))
new_col_name <- paste0("PENCIL_pred_label_", phenotype_name)
new_df[[new_col_name]] <- rep(unique_label, length(all_patients))
# Merge the new data frame with the original data frame based on patient ID and 'yes_no'
cell_counts_new <- merge(cell_counts, new_df, by = c("meta", paste0("PENCIL_pred_label_", phenotype_name)), all = TRUE)
# Replace missing values (NA) in the 'values' column with 0
cell_counts_new$cell_count[is.na(cell_counts_new$cell_count)] <- 0
# Calculate the total count for each patient
df_totals <- aggregate(cell_count ~ meta, cell_counts_new, sum)
# Calculate the count ratios for 'yes' and 'no'
command = paste0('df_ratios <- aggregate(cell_count ~ meta + ',paste0("PENCIL_pred_label_", phenotype_name), ', cell_counts_new, sum)')
eval(parse(text = command))

df_ratios <- transform(df_ratios, ratio = cell_count / df_totals$cell_count * 100)
phenotype_df = merged_seu_subset@meta.data[c('meta', phenotype_name)]
duplicated_rows <- duplicated(phenotype_df[, 1])
phenotype_df <- phenotype_df[!duplicated_rows, ]
# keep only non-duplicated patientID --> dim(phenotype_df.new)=c(48,3)
df_ratios <- merge(df_ratios, phenotype_df, by.x = "meta", by.y = "meta")
df_ratios <- df_ratios[order(df_ratios[,phenotype_name]), ]
df_ratios$meta <- factor(df_ratios$meta, levels = unique(df_ratios$meta))
print(paste(phenotype_name, '+ sample number: ', sum(df_ratios[phenotype_name]==1)/2))

# Plot the stacked bar plot
ggplot(df_ratios, aes(x = meta, y = ratio, fill = PENCIL_pred_label_tissue)) + # paste0("PENCIL_pred_label_", phenotype_name)
  geom_bar(stat = "identity") +
  labs(x = NULL, y = "Percentage (%)", fill = "PENCIL-pred") +
  theme(
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_blank(),  # Removes x-axis labels
    axis.ticks.x = element_blank(), # Removes x-axis tick marks
    legend.position = "none"       # Removes legend
  )
ggsave(filename = paste0(PENCIL_result_dir_deep, "stackedBar_cellRatio_train.pdf"), height = 40, width = 15+25*sampleNUM/15, units = "mm")


# Plot boxplot comparing HPV+ and HPV- samples (Supplementary Figure 2a)
samples_HPVp = c("HNSCC_19", "HNSCC_20", "HNSCC_21", "HNSCC_22", "HNSCC_23", "HNSCC_24", "HNSCC_25", "HNSCC_26")
samples_HPVn = c("HNSCC_1", "HNSCC_10", "HNSCC_11", "HNSCC_12", "HNSCC_13", "HNSCC_14", "HNSCC_15", "HNSCC_16", "HNSCC_17", "HNSCC_18", "HNSCC_2", "HNSCC_3", "HNSCC_4", "HNSCC_5", "HNSCC_6", "HNSCC_7", "HNSCC_8", "HNSCC_9")

TIL_sample_order = c(paste0(samples_HPVp, "_TIL"), paste0(samples_HPVn, "_TIL"))
df_ratios_TIL = df_ratios[df_ratios$meta %in% TIL_sample_order,]
df_ratios_TIL$meta <- factor(as.character(df_ratios_TIL$meta), levels = TIL_sample_order)
df_ratios_TIL <- df_ratios_TIL[order(df_ratios_TIL$meta), ]
sampleNUM = round(nrow(df_ratios_TIL)/2)
# Plot the stacked bar plot
ggplot(df_ratios_TIL, aes(x = meta, y = ratio, fill = PENCIL_pred_label_tissue)) + # paste0("PENCIL_pred_label_", phenotype_name)
  geom_bar(stat = "identity") +
  labs(x = NULL, y = "Percentage (%)", fill = "PENCIL-pred") +
  theme(
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_blank(),  # Removes x-axis labels
    axis.ticks.x = element_blank(), # Removes x-axis tick marks
    legend.position = "none"       # Removes legend
  )
ggsave(filename = paste0(PENCIL_result_dir_deep, "stackedBar_cellRatio_train_TIL_HPV_ordered.pdf"), height = 40, width = 15+25*sampleNUM/15, units = "mm")


PBMC_sample_order = c(paste0(samples_HPVp, "_PBMC"), paste0(samples_HPVn, "_PBMC"))
df_ratios_PBMC = df_ratios[df_ratios$meta %in% PBMC_sample_order,]
df_ratios_PBMC$meta <- factor(as.character(df_ratios_PBMC$meta), levels = PBMC_sample_order)
df_ratios_PBMC <- df_ratios_PBMC[order(df_ratios_PBMC$meta), ]
sampleNUM = round(nrow(df_ratios_PBMC)/2)
# Plot the stacked bar plot
ggplot(df_ratios_PBMC, aes(x = meta, y = ratio, fill = PENCIL_pred_label_tissue)) + # paste0("PENCIL_pred_label_", phenotype_name)
  geom_bar(stat = "identity") +
  labs(x = NULL, y = "Percentage (%)", fill = "PENCIL-pred") +
  theme(
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_blank(),  # Removes x-axis labels
    axis.ticks.x = element_blank(), # Removes x-axis tick marks
    legend.position = "none"       # Removes legend
  )
ggsave(filename = paste0(PENCIL_result_dir_deep, "stackedBar_cellRatio_train_PBMC_HPV_ordered.pdf"), height = 40, width = 15+25*sampleNUM/15, units = "mm")







#### for test1 data
# load seurat object
merged_seu_subset = readRDS(file = paste0(processed_dir_test1,"seu_all3samples_CD8T_PENCIL.rds"))
patient_CD8Tcell_num = sort(table(merged_seu_subset$meta))
keep_patient = names(patient_CD8Tcell_num)[patient_CD8Tcell_num > min_cellNum_per_patient]
merged_seu_subset = subset(merged_seu_subset, subset = meta %in% keep_patient)
sampleNUM = length(unique(merged_seu_subset$meta))
print(paste('Total samples: ', sampleNUM))

# Calculate the cell number for each patient
grouped <- merged_seu_subset@meta.data %>% group_by(meta, !!sym(paste0("PENCIL_pred_label_", phenotype_name)))
# Calculate the number of cells for each patient and predicted_label
cell_counts <- grouped %>% summarise(cell_count = n())
cell_counts <- cell_counts[cell_counts[[paste0("PENCIL_pred_label_", phenotype_name)]] != "rej", ]
# Create a vector with all unique patient IDs
all_patients <- unique(cell_counts$meta)
print(unique(merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_", phenotype_name)]]))

unique_label = c("yes","no")
# Create a new data frame with all patients having both 'yes' and 'no'
new_df <- data.frame(meta = rep(all_patients, each = 2))
new_col_name <- paste0("PENCIL_pred_label_", phenotype_name)
new_df[[new_col_name]] <- rep(unique_label, length(all_patients))
# Merge the new data frame with the original data frame based on patient ID and 'yes_no'
cell_counts_new <- merge(cell_counts, new_df, by = c("meta", paste0("PENCIL_pred_label_", phenotype_name)), all = TRUE)
# Replace missing values (NA) in the 'values' column with 0
cell_counts_new$cell_count[is.na(cell_counts_new$cell_count)] <- 0
# Calculate the total count for each patient
df_totals <- aggregate(cell_count ~ meta, cell_counts_new, sum)
# Calculate the count ratios for 'yes' and 'no'
command = paste0('df_ratios <- aggregate(cell_count ~ meta + ',paste0("PENCIL_pred_label_", phenotype_name), ', cell_counts_new, sum)')
eval(parse(text = command))

df_ratios <- transform(df_ratios, ratio = cell_count / df_totals$cell_count * 100)
phenotype_df = merged_seu_subset@meta.data[c('meta', phenotype_name)]
duplicated_rows <- duplicated(phenotype_df[, 1])
phenotype_df <- phenotype_df[!duplicated_rows, ]
# keep only non-duplicated patientID --> dim(phenotype_df.new)=c(48,3)
df_ratios <- merge(df_ratios, phenotype_df, by.x = "meta", by.y = "meta")
df_ratios <- df_ratios[order(df_ratios[,phenotype_name]), ]
df_ratios$meta <- factor(df_ratios$meta, levels = unique(df_ratios$meta))
print(paste(phenotype_name, '+ sample number: ', sum(df_ratios[phenotype_name]==1)/2))

# Plot the stacked bar plot
ggplot(df_ratios, aes(x = meta, y = ratio, fill = PENCIL_pred_label_tissue)) + # paste0("PENCIL_pred_label_", phenotype_name)
  geom_bar(stat = "identity") +
  labs(x = NULL, y = "Percentage (%)", fill = "PENCIL-pred") +
  theme(
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_blank(),  # Removes x-axis labels
    axis.ticks.x = element_blank(), # Removes x-axis tick marks
    legend.position = "none"       # Removes legend
  )
ggsave(filename = paste0(PENCIL_result_dir_deep, "stackedBar_cellRatio_test1.pdf"), height = 40, width = 15+25*sampleNUM/15, units = "mm")






#### for test2 data
# load seurat object
merged_seu_subset = readRDS(file = paste0(processed_dir_test2,"seu_all_CD8T_PENCIL.rds"))
patient_CD8Tcell_num = sort(table(merged_seu_subset$meta))
keep_patient = names(patient_CD8Tcell_num)[patient_CD8Tcell_num > min_cellNum_per_patient]
merged_seu_subset = subset(merged_seu_subset, subset = meta %in% keep_patient)
sampleNUM = length(unique(merged_seu_subset$meta))
print(paste('Total samples: ', sampleNUM))

# Calculate the cell number for each patient
grouped <- merged_seu_subset@meta.data %>% group_by(meta, !!sym(paste0("PENCIL_pred_label_", phenotype_name)))
# Calculate the number of cells for each patient and predicted_label
cell_counts <- grouped %>% summarise(cell_count = n())
cell_counts <- cell_counts[cell_counts[[paste0("PENCIL_pred_label_", phenotype_name)]] != "rej", ]
# Create a vector with all unique patient IDs
all_patients <- unique(cell_counts$meta)
print(unique(merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_", phenotype_name)]]))

unique_label = c("yes","no")
# Create a new data frame with all patients having both 'yes' and 'no'
new_df <- data.frame(meta = rep(all_patients, each = 2))
new_col_name <- paste0("PENCIL_pred_label_", phenotype_name)
new_df[[new_col_name]] <- rep(unique_label, length(all_patients))
# Merge the new data frame with the original data frame based on patient ID and 'yes_no'
cell_counts_new <- merge(cell_counts, new_df, by = c("meta", paste0("PENCIL_pred_label_", phenotype_name)), all = TRUE)
# Replace missing values (NA) in the 'values' column with 0
cell_counts_new$cell_count[is.na(cell_counts_new$cell_count)] <- 0
# Calculate the total count for each patient
df_totals <- aggregate(cell_count ~ meta, cell_counts_new, sum)
# Calculate the count ratios for 'yes' and 'no'
command = paste0('df_ratios <- aggregate(cell_count ~ meta + ',paste0("PENCIL_pred_label_", phenotype_name), ', cell_counts_new, sum)')
eval(parse(text = command))

df_ratios <- transform(df_ratios, ratio = cell_count / df_totals$cell_count * 100)
phenotype_df = merged_seu_subset@meta.data[c('meta', phenotype_name)]
duplicated_rows <- duplicated(phenotype_df[, 1])
phenotype_df <- phenotype_df[!duplicated_rows, ]
# keep only non-duplicated patientID --> dim(phenotype_df.new)=c(48,3)
df_ratios <- merge(df_ratios, phenotype_df, by.x = "meta", by.y = "meta")
df_ratios <- df_ratios[order(df_ratios[,phenotype_name]), ]
df_ratios$meta <- factor(df_ratios$meta, levels = unique(df_ratios$meta))
print(paste(phenotype_name, '+ sample number: ', sum(df_ratios[phenotype_name]==1)/2))

# Plot the stacked bar plot
ggplot(df_ratios, aes(x = meta, y = ratio, fill = PENCIL_pred_label_tissue)) + # paste0("PENCIL_pred_label_", phenotype_name)
  geom_bar(stat = "identity") +
  labs(x = NULL, y = "Percentage (%)", fill = "PENCIL-pred") +
  theme(
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_blank(),  # Removes x-axis labels
    axis.ticks.x = element_blank(), # Removes x-axis tick marks
    legend.position = "none"       # Removes legend
  )
ggsave(filename = paste0(PENCIL_result_dir_deep, "stackedBar_cellRatio_test2.pdf"), height = 40, width = 15+25*sampleNUM/15, units = "mm")




#### for test3 data
# load seurat object
merged_seu_subset = readRDS(file = paste0(processed_dir_test3,"seu_all_CD8T_PENCIL.rds"))
patient_CD8Tcell_num = sort(table(merged_seu_subset$meta))
keep_patient = names(patient_CD8Tcell_num)[patient_CD8Tcell_num > min_cellNum_per_patient]
merged_seu_subset = subset(merged_seu_subset, subset = meta %in% keep_patient)
sampleNUM = length(unique(merged_seu_subset$meta))
print(paste('Total samples: ', sampleNUM))

# Calculate the cell number for each patient
grouped <- merged_seu_subset@meta.data %>% group_by(meta, !!sym(paste0("PENCIL_pred_label_", phenotype_name)))
# Calculate the number of cells for each patient and predicted_label
cell_counts <- grouped %>% summarise(cell_count = n())
cell_counts <- cell_counts[cell_counts[[paste0("PENCIL_pred_label_", phenotype_name)]] != "rej", ]
# Create a vector with all unique patient IDs
all_patients <- unique(cell_counts$meta)
print(unique(merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_", phenotype_name)]]))

unique_label = c("yes","no")
# Create a new data frame with all patients having both 'yes' and 'no'
new_df <- data.frame(meta = rep(all_patients, each = 2))
new_col_name <- paste0("PENCIL_pred_label_", phenotype_name)
new_df[[new_col_name]] <- rep(unique_label, length(all_patients))
# Merge the new data frame with the original data frame based on patient ID and 'yes_no'
cell_counts_new <- merge(cell_counts, new_df, by = c("meta", paste0("PENCIL_pred_label_", phenotype_name)), all = TRUE)
# Replace missing values (NA) in the 'values' column with 0
cell_counts_new$cell_count[is.na(cell_counts_new$cell_count)] <- 0
# Calculate the total count for each patient
df_totals <- aggregate(cell_count ~ meta, cell_counts_new, sum)
# Calculate the count ratios for 'yes' and 'no'
command = paste0('df_ratios <- aggregate(cell_count ~ meta + ',paste0("PENCIL_pred_label_", phenotype_name), ', cell_counts_new, sum)')
eval(parse(text = command))

df_ratios <- transform(df_ratios, ratio = cell_count / df_totals$cell_count * 100)
phenotype_df = merged_seu_subset@meta.data[c('meta', phenotype_name)]
duplicated_rows <- duplicated(phenotype_df[, 1])
phenotype_df <- phenotype_df[!duplicated_rows, ]
# keep only non-duplicated patientID --> dim(phenotype_df.new)=c(48,3)
df_ratios <- merge(df_ratios, phenotype_df, by.x = "meta", by.y = "meta")
df_ratios <- df_ratios[order(df_ratios[,phenotype_name]), ]
df_ratios$meta <- factor(df_ratios$meta, levels = unique(df_ratios$meta))
print(paste(phenotype_name, '+ sample number: ', sum(df_ratios[phenotype_name]==1)/2))

# Plot the stacked bar plot
ggplot(df_ratios, aes(x = meta, y = ratio, fill = PENCIL_pred_label_tissue)) + # paste0("PENCIL_pred_label_", phenotype_name)
  geom_bar(stat = "identity") +
  labs(x = NULL, y = "Percentage (%)", fill = "PENCIL-pred") +
  theme(
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_blank(),  # Removes x-axis labels
    axis.ticks.x = element_blank(), # Removes x-axis tick marks
    legend.position = "none"       # Removes legend
  )
ggsave(filename = paste0(PENCIL_result_dir_deep, "stackedBar_cellRatio_test3.pdf"), height = 40, width = 15+25*sampleNUM/15, units = "mm")






#### for test4 data
# load seurat object
merged_seu_subset = readRDS(file = paste0(processed_dir_test4,"seu_Tumor_CD8T_tissue_PENCIL.rds"))
merged_seu_subset$tissue = 1
patient_CD8Tcell_num = sort(table(merged_seu_subset$meta))
keep_patient = names(patient_CD8Tcell_num)[patient_CD8Tcell_num > min_cellNum_per_patient]
merged_seu_subset = subset(merged_seu_subset, subset = meta %in% keep_patient)
sampleNUM = length(unique(merged_seu_subset$meta))
print(paste('Total samples: ', sampleNUM))

# Calculate the cell number for each patient
grouped <- merged_seu_subset@meta.data %>% group_by(meta, !!sym(paste0("PENCIL_pred_label_", phenotype_name)))
# Calculate the number of cells for each patient and predicted_label
cell_counts <- grouped %>% summarise(cell_count = n())
cell_counts <- cell_counts[cell_counts[[paste0("PENCIL_pred_label_", phenotype_name)]] != "rej", ]
# Create a vector with all unique patient IDs
all_patients <- unique(cell_counts$meta)
print(unique(merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_", phenotype_name)]]))

unique_label = c("yes","no")
# Create a new data frame with all patients having both 'yes' and 'no'
new_df <- data.frame(meta = rep(all_patients, each = 2))
new_col_name <- paste0("PENCIL_pred_label_", phenotype_name)
new_df[[new_col_name]] <- rep(unique_label, length(all_patients))
# Merge the new data frame with the original data frame based on patient ID and 'yes_no'
cell_counts_new <- merge(cell_counts, new_df, by = c("meta", paste0("PENCIL_pred_label_", phenotype_name)), all = TRUE)
# Replace missing values (NA) in the 'values' column with 0
cell_counts_new$cell_count[is.na(cell_counts_new$cell_count)] <- 0
# Calculate the total count for each patient
df_totals <- aggregate(cell_count ~ meta, cell_counts_new, sum)
# Calculate the count ratios for 'yes' and 'no'
command = paste0('df_ratios <- aggregate(cell_count ~ meta + ',paste0("PENCIL_pred_label_", phenotype_name), ', cell_counts_new, sum)')
eval(parse(text = command))

df_ratios <- transform(df_ratios, ratio = cell_count / df_totals$cell_count * 100)
phenotype_df = merged_seu_subset@meta.data[c('meta', phenotype_name)]
duplicated_rows <- duplicated(phenotype_df[, 1])
phenotype_df <- phenotype_df[!duplicated_rows, ]
# keep only non-duplicated patientID --> dim(phenotype_df.new)=c(48,3)
df_ratios <- merge(df_ratios, phenotype_df, by.x = "meta", by.y = "meta")
df_ratios <- df_ratios[order(df_ratios[,phenotype_name]), ]
df_ratios$meta <- factor(df_ratios$meta, levels = unique(df_ratios$meta))
print(paste(phenotype_name, '+ sample number: ', sum(df_ratios[phenotype_name]==1)/2))

# Plot the stacked bar plot
ggplot(df_ratios, aes(x = meta, y = ratio, fill = PENCIL_pred_label_tissue)) + # paste0("PENCIL_pred_label_", phenotype_name)
  geom_bar(stat = "identity") +
  labs(x = NULL, y = "Percentage (%)", fill = "PENCIL-pred") +
  theme(
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_blank(),  # Removes x-axis labels
    axis.ticks.x = element_blank(), # Removes x-axis tick marks
    legend.position = "none"       # Removes legend
  )
ggsave(filename = paste0(PENCIL_result_dir_deep, "stackedBar_cellRatio_test4.pdf"), height = 40, width = 15+25*sampleNUM/15, units = "mm")





#### for test5 data
# load seurat object
merged_seu_subset = readRDS(file = paste0(processed_dir_test5,"seu_Tissue_CD8T_tissue_PENCIL.rds"))
merged_seu_subset$tissue = 1
patient_CD8Tcell_num = sort(table(merged_seu_subset$meta))
keep_patient = names(patient_CD8Tcell_num)[patient_CD8Tcell_num > min_cellNum_per_patient]
merged_seu_subset = subset(merged_seu_subset, subset = meta %in% keep_patient)
sampleNUM = length(unique(merged_seu_subset$meta))
print(paste('Total samples: ', sampleNUM))

# Calculate the cell number for each patient
grouped <- merged_seu_subset@meta.data %>% group_by(meta, !!sym(paste0("PENCIL_pred_label_", phenotype_name)))
# Calculate the number of cells for each patient and predicted_label
cell_counts <- grouped %>% summarise(cell_count = n())
cell_counts <- cell_counts[cell_counts[[paste0("PENCIL_pred_label_", phenotype_name)]] != "rej", ]
# Create a vector with all unique patient IDs
all_patients <- unique(cell_counts$meta)
print(unique(merged_seu_subset@meta.data[[paste0("PENCIL_pred_label_", phenotype_name)]]))

unique_label = c("yes","no")
# Create a new data frame with all patients having both 'yes' and 'no'
new_df <- data.frame(meta = rep(all_patients, each = 2))
new_col_name <- paste0("PENCIL_pred_label_", phenotype_name)
new_df[[new_col_name]] <- rep(unique_label, length(all_patients))
# Merge the new data frame with the original data frame based on patient ID and 'yes_no'
cell_counts_new <- merge(cell_counts, new_df, by = c("meta", paste0("PENCIL_pred_label_", phenotype_name)), all = TRUE)
# Replace missing values (NA) in the 'values' column with 0
cell_counts_new$cell_count[is.na(cell_counts_new$cell_count)] <- 0
# Calculate the total count for each patient
df_totals <- aggregate(cell_count ~ meta, cell_counts_new, sum)
# Calculate the count ratios for 'yes' and 'no'
command = paste0('df_ratios <- aggregate(cell_count ~ meta + ',paste0("PENCIL_pred_label_", phenotype_name), ', cell_counts_new, sum)')
eval(parse(text = command))

df_ratios <- transform(df_ratios, ratio = cell_count / df_totals$cell_count * 100)
phenotype_df = merged_seu_subset@meta.data[c('meta', phenotype_name)]
duplicated_rows <- duplicated(phenotype_df[, 1])
phenotype_df <- phenotype_df[!duplicated_rows, ]
# keep only non-duplicated patientID --> dim(phenotype_df.new)=c(48,3)
df_ratios <- merge(df_ratios, phenotype_df, by.x = "meta", by.y = "meta")
df_ratios <- df_ratios[order(df_ratios[,phenotype_name]), ]
df_ratios$meta <- factor(df_ratios$meta, levels = unique(df_ratios$meta))
print(paste(phenotype_name, '+ sample number: ', sum(df_ratios[phenotype_name]==1)/2))

# Plot the stacked bar plot
ggplot(df_ratios, aes(x = meta, y = ratio, fill = PENCIL_pred_label_tissue)) + # paste0("PENCIL_pred_label_", phenotype_name)
  geom_bar(stat = "identity") +
  labs(x = NULL, y = "Percentage (%)", fill = "PENCIL-pred") +
  theme(
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_blank(),  # Removes x-axis labels
    axis.ticks.x = element_blank(), # Removes x-axis tick marks
    legend.position = "none"       # Removes legend
  )
ggsave(filename = paste0(PENCIL_result_dir_deep, "stackedBar_cellRatio_test5.pdf"), height = 40, width = 15+25*sampleNUM/15, units = "mm")



# Plot boxplot comparing HPV+ and HPV- samples (Supplementary Figure 2b)
samples_HPVp = c("OP20","OP6CD45P","OP34","OP33","OP5","OP14CD45P","OP4CD45P")
samples_HPVn = c("OP10", "OP12", "OP16", "OP8")

TIL_sample_order = c(samples_HPVp, samples_HPVn)
df_ratios_TIL = df_ratios[df_ratios$meta %in% TIL_sample_order,]
df_ratios_TIL$meta <- factor(as.character(df_ratios_TIL$meta), levels = TIL_sample_order)
df_ratios_TIL <- df_ratios_TIL[order(df_ratios_TIL$meta), ]
sampleNUM = round(nrow(df_ratios_TIL)/2)
# Plot the stacked bar plot
ggplot(df_ratios_TIL, aes(x = meta, y = ratio, fill = PENCIL_pred_label_tissue)) + # paste0("PENCIL_pred_label_", phenotype_name)
  geom_bar(stat = "identity") +
  labs(x = NULL, y = "Percentage (%)", fill = "PENCIL-pred") +
  theme(
    panel.background = element_rect(fill = "white"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_blank(),  # Removes x-axis labels
    axis.ticks.x = element_blank(), # Removes x-axis tick marks
    legend.position = "none"       # Removes legend
  )
ggsave(filename = paste0(PENCIL_result_dir_deep, "stackedBar_cellRatio_test5_HPV_ordered.pdf"), height = 40, width = 15+25*sampleNUM/15, units = "mm")


```


